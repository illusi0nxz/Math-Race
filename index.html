Here is the updated complete code. I have expanded the **Spelling Bee** word database significantly. It now includes **12 categories** (the original 6 plus 6 new ones: **Sports, Clothes, Body, Space, Jobs, and Vehicles**).

I have also ensured the layout adjusts automatically to fit the new buttons.

### Complete Updated Code

```html
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <title>Adventure Hub</title>
 <style>
 :root {
  --red:#e74c3c;--green:#00b894;--blue:#0984e3;--purple:#6c5ce7;
  --orange:#f39c12;--pink:#fd79a8;--cyan:#00cec9;--dark:#2d3436;
  --gray:#636e72;--light:#dfe6e9;--yellow:#ffeaa7;
 }
 *{margin:0;padding:0;box-sizing:border-box}
 body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:linear-gradient(135deg,#0c0c1d 0%,#1a1a3e 50%,#0f2460 100%);
  min-height:100vh;display:flex;flex-direction:column;align-items:center;
  padding:8px;overflow-x:hidden;color:var(--dark);
  -webkit-tap-highlight-color:transparent;
 }
 @keyframes bounceIn{0%{transform:scale(.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(.95)}100%{transform:scale(1);opacity:1}}
 @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
 @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
 @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
 @keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
 @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
 @keyframes confettiFall{0%{transform:translateY(-10px)rotate(0deg);opacity:1}100%{transform:translateY(100vh)rotate(720deg);opacity:0}}
 @keyframes starFloat{0%{transform:translateY(100vh)rotate(0);opacity:0}10%{opacity:.25}90%{opacity:.25}100%{transform:translateY(-10vh)rotate(360deg);opacity:0}}
 @keyframes timerPulse{0%,100%{color:var(--red);transform:scale(1)}50%{transform:scale(1.12)}}
 @keyframes racerBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
 @keyframes popIn{0%{transform:scale(0);opacity:0}80%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
 @keyframes floatUp{0%{opacity:1;transform:translate(-50%,-50%)}100%{opacity:0;transform:translate(-50%,-150%)}}
 @keyframes dotPulse{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}
 @keyframes spinLoad{to{transform:rotate(360deg)}}
 @keyframes coinSpin{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}
 @keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
 @keyframes shelfSlide{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
 .stars-bg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;overflow:hidden}
 .floating-star{position:absolute;animation:starFloat linear infinite;opacity:.25}
 .celebration-layer{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:200}
 .confetti-piece{position:absolute;border-radius:2px;animation:confettiFall linear forwards}
 .container{position:relative;z-index:1;width:100%;max-width:950px}
 .screen{display:none;animation:bounceIn .5s ease}
 .screen.active{display:block}
 .card{background:white;border-radius:22px;padding:22px;box-shadow:0 12px 45px rgba(0,0,0,.35);text-align:center;margin-bottom:15px}
 .big-title{font-size:2em;margin-bottom:3px;text-shadow:2px 2px 0 #ffeaa7}
 .sub-text{font-size:1em;color:#999;margin-bottom:15px}
 .field-label{display:block;font-size:1em;color:#555;margin-bottom:6px;text-align:left;margin-left:8px}
 .text-input{width:100%;max-width:300px;font-size:1.1em;padding:10px 14px;border:3px solid var(--light);border-radius:14px;text-align:center;outline:none;transition:border-color .3s;-webkit-appearance:none}
 .text-input:focus{border-color:var(--red)}
 .section-title{font-size:1.15em;color:var(--dark);margin:18px 0 8px}
 .option-grid{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;margin-bottom:6px}
 .option-btn{padding:9px 16px;border:3px solid transparent;border-radius:13px;font-size:.9em;font-weight:bold;cursor:pointer;transition:all .25s;min-width:95px;color:white;-webkit-appearance:none}
 .option-btn:hover,.option-btn:active{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
 .option-btn.selected{border-color:var(--dark);transform:scale(1.05)}
 .opt-easy{background:linear-gradient(135deg,#00b894,#00cec9)}
 .opt-medium{background:linear-gradient(135deg,#fdcb6e,#f39c12)}
 .opt-hard{background:linear-gradient(135deg,#e74c3c,#fd79a8)}
 .desc-text{font-size:.8em;color:#999;min-height:16px;margin-top:4px}
 .big-btn{margin-top:18px;padding:14px 40px;font-size:1.2em;font-weight:bold;color:white;border:none;border-radius:20px;cursor:pointer;transition:all .3s;box-shadow:0 8px 25px rgba(0,0,0,.3);-webkit-appearance:none}
 .big-btn:hover:not(:disabled),.big-btn:active:not(:disabled){transform:translateY(-3px);box-shadow:0 12px 35px rgba(0,0,0,.4)}
 .big-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
 .btn-red{background:linear-gradient(135deg,#e74c3c,#fd79a8)}
 .btn-green{background:linear-gradient(135deg,#00b894,#55efc4)}
 .btn-blue{background:linear-gradient(135deg,#0984e3,#74b9ff)}
 .btn-orange{background:linear-gradient(135deg,#f39c12,#fdcb6e)}
 .btn-purple{background:linear-gradient(135deg,#6c5ce7,#a29bfe)}
 .back-btn{display:inline-block;margin-bottom:12px;padding:7px 16px;font-size:.85em;background:none;border:2px solid #ddd;border-radius:11px;cursor:pointer;color:#888;transition:all .2s;-webkit-appearance:none}
 .back-btn:hover,.back-btn:active{border-color:#aaa;color:#555}
 .home-btn{display:inline-block;padding:7px 16px;font-size:.85em;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;border-radius:11px;cursor:pointer;color:white;font-weight:bold;transition:all .2s;-webkit-appearance:none}
 .home-btn:hover,.home-btn:active{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
 .secondary-btn{padding:10px 24px;font-size:.95em;font-weight:bold;color:var(--red);background:white;border:3px solid var(--red);border-radius:18px;cursor:pointer;transition:all .3s;-webkit-appearance:none}
 .secondary-btn:hover,.secondary-btn:active{background:#fff5f5}
 .btn-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:15px}
 .toast{position:fixed;top:15px;left:50%;transform:translateX(-50%);background:var(--dark);color:white;padding:10px 20px;border-radius:11px;font-size:.95em;z-index:400;animation:slideDown .3s ease;box-shadow:0 5px 20px rgba(0,0,0,.4);max-width:90%;text-align:center}
 .toast.success{background:var(--green)}.toast.error{background:var(--red)}
 .float-text{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.6em;font-weight:bold;pointer-events:none;z-index:210;animation:floatUp 1.2s ease forwards;text-shadow:2px 2px 4px rgba(0,0,0,.4)}
 .countdown-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:300;justify-content:center;align-items:center}
 .countdown-overlay.active{display:flex}
 .countdown-number{font-size:6em;font-weight:bold;color:white;text-shadow:0 0 40px rgba(255,255,255,.4);animation:bounceIn .45s ease}
 .loading-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:350;justify-content:center;align-items:center;flex-direction:column;gap:12px}
 .loading-overlay.active{display:flex}
 .spinner{width:45px;height:45px;border:5px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spinLoad .8s linear infinite}
 .loading-text{color:white;font-size:1em;font-weight:bold}
 .conn-status{position:fixed;bottom:8px;right:8px;padding:4px 10px;border-radius:8px;font-size:.7em;font-weight:bold;z-index:50;display:none}
 .conn-status.online{background:#00b894;color:white;display:block}
 .conn-status.offline{background:#636e72;color:white;display:block}
 .waiting-dots::after{content:'';animation:dotPulse 1.5s steps(4,end) infinite}
 /* ===== GAME HUB ===== */
 .hub-mascot{font-size:55px;animation:bounce 2s infinite;display:block;margin-bottom:5px}
 .game-cards{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;margin:20px 0}
 .game-card{background:white;border-radius:20px;padding:20px;width:280px;box-shadow:0 8px 30px rgba(0,0,0,.15);cursor:pointer;transition:all .3s;border:3px solid transparent;text-align:center}
 .game-card:hover,.game-card:active{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,.25)}
 .game-card .gc-icon{font-size:3em;display:block;margin-bottom:8px}
 .game-card .gc-title{font-size:1.2em;font-weight:bold;color:var(--dark);margin-bottom:4px}
 .game-card .gc-desc{font-size:.85em;color:#888;margin-bottom:10px}
 .game-card .gc-tag{display:inline-block;padding:3px 10px;border-radius:10px;font-size:.7em;font-weight:bold;color:white}
 .gc-tag-race{background:var(--red)}.gc-tag-shop{background:var(--green)}
 .gc-tag-spell{background:var(--purple)}.gc-tag-frac{background:var(--orange)}
 /* ===== MATH RACE STYLES ===== */
 .mode-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:18px 0}
 .mode-btn{padding:16px 24px;border:none;border-radius:18px;font-size:1.05em;font-weight:bold;color:white;cursor:pointer;transition:all .3s;min-width:180px;box-shadow:0 6px 20px rgba(0,0,0,.2);-webkit-appearance:none}
 .mode-btn:hover,.mode-btn:active{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,.3)}
 .mode-solo{background:linear-gradient(135deg,#0984e3,#74b9ff)}
 .mode-host{background:linear-gradient(135deg,#e74c3c,#fd79a8)}
 .mode-join{background:linear-gradient(135deg,#00b894,#55efc4)}
 .racer-picker{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;margin:8px 0}
 .racer-option{font-size:2em;padding:6px 10px;border:3px solid var(--light);border-radius:13px;cursor:pointer;transition:all .25s;background:white;-webkit-appearance:none}
 .racer-option:hover,.racer-option:active{transform:scale(1.12);border-color:var(--red)}
 .racer-option.selected{border-color:var(--red);background:#fff5f5;transform:scale(1.12)}
 .ai-config-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0;text-align:left}
 .ai-card{background:#f8f9fa;border-radius:12px;padding:10px;border:2px solid var(--light)}
 .ai-card-header{display:flex;align-items:center;gap:6px;margin-bottom:6px}
 .ai-card-emoji{font-size:1.4em}.ai-card-name{font-weight:bold;font-size:.85em}
 .ai-card label{font-size:.75em;color:#777;display:block;margin-bottom:2px}
 .ai-slider{width:100%;margin:3px 0;cursor:pointer;accent-color:var(--red)}
 .ai-speed-label{font-size:.7em;color:var(--orange);font-weight:bold}
 .room-code-display{font-size:2.2em;font-weight:bold;letter-spacing:7px;color:var(--red);background:#fff5f5;border-radius:14px;padding:12px 22px;display:inline-block;margin:8px 0;border:3px dashed var(--red);user-select:all;cursor:pointer}
 .copy-hint{font-size:.8em;color:#aaa;margin-bottom:12px}
 .players-lobby{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
 .lobby-player{background:#f0f8ff;border-radius:12px;padding:8px 14px;text-align:center;min-width:80px;border:2px solid #bee3f8;animation:popIn .4s ease}
 .lobby-player.is-host{border-color:var(--red);background:#fff5f5}
 .lobby-player .lp-emoji{font-size:1.6em;display:block}
 .lobby-player .lp-name{font-size:.8em;font-weight:bold;color:var(--dark)}
 .lobby-player .lp-tag{font-size:.65em;color:var(--red);font-weight:bold}
 .lobby-ai-list{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:8px 0}
 .lobby-ai{background:#f8f9fa;border-radius:8px;padding:5px 10px;font-size:.8em;color:var(--gray)}
 .lobby-status{font-size:.95em;color:#999;margin:8px 0}
 .join-input{font-size:1.6em;font-weight:bold;letter-spacing:5px;text-transform:uppercase;max-width:220px}
 .game-top-bar{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.12);backdrop-filter:blur(10px);border-radius:14px;padding:8px 14px;margin-bottom:8px;color:white;flex-wrap:wrap;gap:5px}
 .player-info{font-weight:bold;font-size:.95em}
 .timer-display{font-size:1.1em;font-weight:bold;font-variant-numeric:tabular-nums}
 .timer-display.warning{animation:timerPulse .5s infinite}
 .stats-bar{display:flex;gap:10px;font-size:.85em}
 .stat{display:flex;align-items:center;gap:3px}
 .race-track-wrapper{background:linear-gradient(180deg,#e8eaed,#c8ced3);border-radius:16px;padding:10px;margin-bottom:8px;box-shadow:inset 0 3px 12px rgba(0,0,0,.12);overflow:hidden}
 .race-track-title{text-align:center;font-size:.85em;color:var(--gray);margin-bottom:6px;font-weight:bold}
 .race-lane{display:flex;align-items:center;margin-bottom:3px;height:34px;position:relative}
 .lane-label{width:75px;font-size:.65em;font-weight:bold;color:var(--dark);text-align:right;padding-right:5px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
 .lane-track{flex:1;height:28px;background:linear-gradient(90deg,#ffeaa7,#fdcb6e);border-radius:14px;position:relative;overflow:visible;border:2px solid var(--orange)}
 .lane-track.human-lane{background:linear-gradient(90deg,#81ecec,#00cec9);border-color:var(--green);height:32px;border-radius:16px}
 .lane-track.ai-lane{opacity:.85}
 .racer-icon{position:absolute;top:50%;transform:translateY(-50%);font-size:1.3em;transition:left .6s cubic-bezier(.25,.46,.45,.94);z-index:2;filter:drop-shadow(1px 1px 2px rgba(0,0,0,.25));left:1%}
 .racer-icon.moving{animation:racerBounce .3s ease 2}
 .human-lane .racer-icon{font-size:1.5em}
 .finish-flag{position:absolute;right:2px;top:50%;transform:translateY(-50%);font-size:.85em;z-index:1}
 .checkpoint{position:absolute;top:50%;transform:translateY(-50%);font-size:.55em;opacity:.3}
 .question-card{background:white;border-radius:18px;padding:18px;box-shadow:0 8px 35px rgba(0,0,0,.22);text-align:center}
 .q-number{font-size:.78em;color:#b2bec3;margin-bottom:2px}
 .q-type-badge{display:inline-block;padding:3px 11px;border-radius:16px;font-size:.72em;font-weight:bold;color:white;margin-bottom:10px}
 .badge-add{background:var(--blue)}.badge-sub{background:#e17055}.badge-mul{background:var(--green)}.badge-div{background:var(--purple)}
 .question-display{font-size:2.4em;font-weight:bold;color:var(--dark);margin:10px 0;letter-spacing:3px}
 .question-display .q-op{color:var(--red)}
 .answer-row{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;margin:10px 0}
 .answer-input{font-size:1.6em;font-weight:bold;padding:10px 16px;border:4px solid var(--light);border-radius:14px;text-align:center;width:140px;outline:none;transition:all .3s;color:var(--dark);-webkit-appearance:none}
 .answer-input:focus{border-color:var(--red);box-shadow:0 0 12px rgba(231,76,60,.15)}
 .answer-input.correct-flash{border-color:var(--green);background:#f0fff4;animation:pulse .35s}
 .answer-input.wrong-flash{border-color:var(--red);background:#fff5f5;animation:shake .45s}
 .submit-btn{padding:10px 24px;font-size:1.1em;font-weight:bold;color:white;background:linear-gradient(135deg,var(--red),var(--pink));border:none;border-radius:13px;cursor:pointer;transition:all .3s;-webkit-appearance:none}
 .submit-btn:hover,.submit-btn:active{transform:translateY(-2px)}
 .submit-btn:disabled{opacity:.4;cursor:not-allowed}
 .feedback-area{min-height:40px;margin:6px 0 3px;font-size:1em;font-weight:bold}
 .fb-emoji{font-size:1.4em;display:block;margin-bottom:2px}
 .fb-correct{color:var(--green)}.fb-wrong{color:var(--red)}
 .hint-box{background:#fff9e6;border:2px solid #ffd200;border-radius:11px;padding:8px 12px;margin-top:5px;text-align:left;font-size:.85em;color:#555;display:none;animation:slideDown .3s ease}
 .hint-box strong{color:var(--orange)}
 .results-trophy{font-size:65px;margin:6px 0}
 .results-title{font-size:1.8em;color:var(--red);margin-bottom:3px}
 .results-subtitle{font-size:.95em;color:#888;margin-bottom:12px}
 .final-standings{margin:12px 0;text-align:left}
 .standing-row{display:flex;align-items:center;padding:8px 12px;border-radius:10px;margin-bottom:4px;background:#f8f9fa;gap:7px}
 .standing-row.is-you{background:linear-gradient(90deg,#dff9fb,#c7ecee);border:2px solid var(--cyan)}
 .standing-pos{font-size:1.1em;font-weight:bold;width:30px;text-align:center}
 .standing-emoji{font-size:1.2em}
 .standing-name{flex:1;font-weight:bold;font-size:.9em}
 .standing-pct{font-size:.78em;color:#888}
 .results-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
 .r-stat{background:#f8f9fa;border-radius:11px;padding:10px 6px}
 .r-stat-val{font-size:1.4em;font-weight:bold;color:var(--red)}
 .r-stat-lbl{font-size:.7em;color:#888;margin-top:2px}
 .results-msg{padding:10px;background:#f0fff4;border-radius:11px;font-size:.95em;color:#555;margin:10px 0}
 .wrong-review{text-align:left;margin:10px 0}
 .wrong-review h3{color:var(--red);margin-bottom:6px;text-align:center;font-size:1em}
 .review-item{display:flex;justify-content:space-between;align-items:center;background:#fff5f5;border-radius:8px;padding:6px 10px;margin-bottom:3px;flex-wrap:wrap;gap:3px;font-size:.85em}
 .review-q{font-weight:bold}.review-a{color:var(--green);font-weight:bold}
 /* ===== MATH MARKET STYLES ===== */
 .shop-header{background:linear-gradient(135deg,#00b894,#55efc4);border-radius:16px;padding:12px 18px;margin-bottom:10px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
 .shop-name{font-weight:bold;font-size:1.1em}
 .shop-stats{display:flex;gap:12px;font-size:.9em}
 .shop-stat{display:flex;align-items:center;gap:3px}
 .coin-icon{animation:coinSpin 2s linear infinite;display:inline-block}
 .shop-shelf{background:white;border-radius:18px;padding:15px;box-shadow:0 8px 30px rgba(0,0,0,.2);margin-bottom:10px}
 .shelf-title{font-size:1em;color:var(--gray);margin-bottom:10px;font-weight:bold}
 .shelf-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px}
 .shop-item{background:#f8f9fa;border-radius:12px;padding:10px;text-align:center;cursor:pointer;transition:all .25s;border:2px solid transparent;user-select:none}
 .shop-item:hover,.shop-item:active{transform:scale(1.05);border-color:var(--green);background:#f0fff4}
 .shop-item.in-cart{border-color:var(--green);background:#f0fff4}
 .shop-item.disabled-item{opacity:.5;cursor:not-allowed;transform:none;border-color:transparent;background:#f8f9fa}
 .shop-item .item-emoji{font-size:1.8em;display:block}
 .shop-item .item-name{font-size:.7em;color:var(--dark);font-weight:bold;margin:2px 0}
 .shop-item .item-price{font-size:.75em;color:var(--green);font-weight:bold}
 .cart-panel{background:white;border-radius:18px;padding:15px;box-shadow:0 8px 30px rgba(0,0,0,.2);margin-bottom:10px}
 .cart-title{font-size:1em;color:var(--dark);margin-bottom:8px;font-weight:bold;display:flex;justify-content:space-between;align-items:center}
 .cart-items{min-height:40px}
 .cart-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#f8f9fa;border-radius:8px;margin-bottom:4px;animation:slideIn .3s ease;font-size:.9em}
 .cart-row-left{display:flex;align-items:center;gap:6px}
 .cart-qty{display:flex;align-items:center;gap:4px}
 .qty-btn{width:28px;height:28px;border-radius:50%;border:2px solid var(--light);background:white;font-size:1em;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;transition:all .2s;-webkit-appearance:none}
 .qty-btn:hover,.qty-btn:active{background:var(--green);color:white;border-color:var(--green)}
 .qty-num{font-weight:bold;min-width:20px;text-align:center;font-size:1.1em}
 .cart-row-price{font-weight:bold;color:var(--green)}
 .cart-empty{color:#ccc;font-size:.9em;padding:15px;text-align:center}
 .cart-total{display:flex;justify-content:space-between;align-items:center;padding:10px;background:linear-gradient(135deg,#dff9fb,#c7ecee);border-radius:10px;margin-top:8px;font-weight:bold;font-size:1.1em}
 .checkout-card{background:white;border-radius:18px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.2);text-align:center}
 .checkout-q{font-size:1.3em;font-weight:bold;color:var(--dark);margin:10px 0}
 .checkout-hint{font-size:.85em;color:#999;margin-bottom:8px}
 .checkout-breakdown{background:#f8f9fa;border-radius:12px;padding:10px;margin:10px 0;text-align:left;font-size:.9em}
 .breakdown-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #eee}
 .breakdown-row:last-child{border-bottom:none;font-weight:bold;color:var(--green);font-size:1.05em}
 .market-modes{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0}
 .market-mode{background:white;border-radius:16px;padding:15px;width:200px;box-shadow:0 5px 20px rgba(0,0,0,.1);cursor:pointer;transition:all .3s;border:3px solid transparent;text-align:center}
 .market-mode:hover,.market-mode:active{transform:translateY(-3px);border-color:var(--green)}
 .market-mode .mm-icon{font-size:2em;display:block;margin-bottom:5px}
 .market-mode .mm-title{font-weight:bold;font-size:1em;color:var(--dark)}
 .market-mode .mm-desc{font-size:.75em;color:#888;margin-top:3px}
 .day-progress{display:flex;gap:4px;justify-content:center;margin:10px 0}
 .day-dot{width:24px;height:24px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:.6em;font-weight:bold;color:white;transition:all .3s}
 .day-dot.complete{background:var(--green)}
 .day-dot.current{background:var(--orange);animation:pulse 1s infinite}
 .day-dot.locked{background:#ddd}
 .customer-bubble{background:linear-gradient(135deg,#f8f9fa,#fff);border-radius:16px;padding:15px;margin:10px 0;border:2px solid #eee;text-align:left;animation:slideDown .4s ease}
 .customer-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
 .customer-avatar{font-size:2em}
 .customer-name{font-weight:bold;color:var(--dark)}
 .customer-order{font-size:1em;color:#555;line-height:1.6}
 .level-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.75em;font-weight:bold;color:white;margin-bottom:8px}
 .level-1{background:var(--green)}.level-2{background:var(--orange)}.level-3{background:var(--red)}.level-4{background:var(--purple)}.level-5{background:var(--blue)}
 .xp-bar-container{background:#eee;border-radius:10px;height:14px;width:100%;max-width:300px;margin:8px auto;overflow:hidden}
 .xp-bar{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:10px;transition:width .8s ease}
 .xp-text{font-size:.75em;color:#999;margin-top:2px}
 .achievement-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:20px;padding:25px;box-shadow:0 15px 50px rgba(0,0,0,.4);z-index:250;text-align:center;animation:bounceIn .5s ease;max-width:300px}
 .achievement-popup .ach-icon{font-size:3em;display:block;margin-bottom:8px}
 .achievement-popup .ach-title{font-size:1.2em;font-weight:bold;color:var(--dark);margin-bottom:4px}
 .achievement-popup .ach-desc{font-size:.9em;color:#888}
 .achievement-popup .ach-close{margin-top:12px;padding:8px 25px;font-size:1em;font-weight:bold;color:white;background:var(--green);border:none;border-radius:12px;cursor:pointer}
 .shop-results-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
 .budget-warning{background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:8px;margin:8px 0;font-size:.85em;color:#856404;font-weight:bold;animation:shake .5s}
 .budget-ok{color:var(--green)}.budget-over{color:var(--red)}
 .config-panel{background:#f0f8ff;border-radius:14px;padding:15px;margin:12px 0;border:2px solid #bee3f8;text-align:left}
 .config-title{font-size:1em;font-weight:bold;color:var(--blue);margin-bottom:10px;text-align:center}
 .config-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:5px}
 .config-label{font-size:.9em;color:#555;font-weight:bold}
 .config-toggle{position:relative;width:50px;height:26px;background:#ccc;border-radius:13px;cursor:pointer;transition:background .3s;-webkit-appearance:none;border:none}
 .config-toggle.active{background:var(--green)}
 .config-toggle::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:white;border-radius:50%;transition:transform .3s}
 .config-toggle.active::after{transform:translateX(24px)}
 /* ===== SPELLING BEE (adapted styles) ===== */
 .spell-app-container{
  background:white;border-radius:30px;padding:25px 20px;max-width:900px;width:100%;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;position:relative;
  overflow:hidden;margin:10px auto;
 }
 .spell-app-container::before{
  content:'';position:absolute;top:0;left:0;right:0;height:6px;
  background:linear-gradient(90deg,#ff6b6b,#feca57,#48dbfb,#ff9ff3,#54a0ff);
 }
 .spell-title{font-family:'Segoe UI',sans-serif;font-weight:800;color:#5f27cd;font-size:2em;margin-bottom:4px}
 .spell-subtitle{color:#8854d0;font-size:1em;margin-bottom:18px}
 .spell-screen{display:none}
 .spell-screen.active{display:block}
 .bee-icon{font-size:60px;animation:bounce 2s infinite}
 .category-title{font-weight:bold;color:#341f97;font-size:1.1em;margin:15px 0 10px}
 .category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:18px}
 .category-btn{padding:12px 10px;border:3px solid #dfe6e9;border-radius:15px;background:white;cursor:pointer;transition:all .3s;font-size:.95em;font-weight:700;color:#2d3436}
 .category-btn:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
 .category-btn.selected{border-color:#6c5ce7;background:#f0edff;color:#6c5ce7}
 .cat-emoji{font-size:1.6em;display:block;margin-bottom:3px}
 .start-btn{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:white;border:none;padding:14px 35px;font-size:1.2em;border-radius:30px;cursor:pointer;transition:all .3s;box-shadow:0 5px 20px rgba(108,92,231,0.4)}
 .start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(108,92,231,0.5)}
 .start-btn:disabled{background:#b2bec3;box-shadow:none;cursor:not-allowed;transform:none}
 .diff-btn{padding:8px 16px;border:2px solid #ddd;border-radius:20px;background:white;font-weight:700;font-size:.9em;cursor:pointer;margin:3px;transition:all .3s}
 .diff-btn.selected{border-color:#6c5ce7;background:#f0edff;color:#6c5ce7}
 .progress-container{background:#f0f0f0;border-radius:20px;height:18px;margin-bottom:18px;overflow:hidden;position:relative}
 .progress-bar{height:100%;background:linear-gradient(90deg,#00b894,#00cec9);border-radius:20px;transition:width .5s ease;position:relative}
 .progress-text{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:.7em;font-weight:700;color:#2d3436}
 .score-display{display:flex;justify-content:center;gap:25px;margin-bottom:15px;font-size:.95em}
 .score-item{display:flex;align-items:center;gap:6px;font-weight:700}
 .score-item .icon{font-size:1.3em}
 .image-container{background:linear-gradient(135deg,#f8f9fa,#e9ecef);border-radius:20px;padding:15px;margin-bottom:15px;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:3px dashed #dee2e6}
 .emoji-display{font-size:90px;line-height:1.2}
 .sound-btn{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;border:none;padding:8px 18px;border-radius:22px;font-size:.9em;font-weight:700;cursor:pointer;margin-top:8px;transition:all .3s}
 .sound-btn:hover{transform:scale(1.05)}
 .letter-boxes{display:flex;justify-content:center;gap:6px;margin-bottom:15px;flex-wrap:wrap}
 .letter-box{width:42px;height:46px;border:3px solid #dfe6e9;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4em;font-weight:700;color:#2d3436;background:white;transition:all .3s;text-transform:uppercase}
 .letter-box.filled{border-color:#6c5ce7;background:#f0edff;color:#6c5ce7}
 .letter-box.correct{border-color:#00b894;background:#d5f5e3;color:#00b894;animation:popIn .3s ease}
 .letter-box.incorrect{border-color:#ff6b6b;background:#ffe0e0;color:#ff6b6b;animation:shake .5s ease}
 .letter-box.hint{border-color:#fdcb6e;background:#ffeaa7;color:#e17055}
 .spell-input{width:100%;max-width:400px;padding:12px 20px;font-size:1.3em;font-weight:700;text-align:center;border:3px solid #dfe6e9;border-radius:15px;outline:none;transition:all .3s;letter-spacing:5px;text-transform:uppercase}
 .spell-input:focus{border-color:#6c5ce7;box-shadow:0 0 0 4px rgba(108,92,231,0.1)}
 .spell-input.correct-input{border-color:#00b894;background:#f0fff4}
 .spell-input.incorrect-input{border-color:#ff6b6b;background:#fff5f5}
 .btn-group{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
 .action-btn{padding:9px 22px;border:none;border-radius:22px;font-size:1em;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:6px}
 .check-btn{background:linear-gradient(135deg,#00b894,#00cec9);color:white;box-shadow:0 4px 15px rgba(0,184,148,0.3)}
 .hint-btn{background:linear-gradient(135deg,#fdcb6e,#f39c12);color:white;box-shadow:0 4px 15px rgba(253,203,110,0.3)}
 .skip-btn{background:linear-gradient(135deg,#fd79a8,#e84393);color:white;box-shadow:0 4px 15px rgba(253,121,168,0.3)}
 .next-btn{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:white;box-shadow:0 4px 15px rgba(108,92,231,0.3);font-size:1.1em;padding:11px 26px}
 .action-btn:hover{transform:translateY(-2px)}
 .action-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
 .feedback{padding:11px 18px;border-radius:15px;margin-bottom:10px;font-weight:700;font-size:1em;display:none;animation:fadeIn .3s ease;white-space:pre-line}
 .feedback.success{background:#d5f5e3;color:#00b894;border:2px solid #00b894;display:block}
 .feedback.error{background:#ffe0e0;color:#e74c3c;border:2px solid #ff6b6b;display:block}
 .feedback.hint-msg{background:#ffeaa7;color:#e17055;border:2px solid #fdcb6e;display:block}
 .word-info{background:#f8f9fa;border-radius:15px;padding:10px;margin-top:8px;display:none;text-align:left;font-size:.9em}
 .word-info.visible{display:block;animation:fadeIn .3s ease}
 .word-info .word-label{font-weight:700;color:#6c5ce7}
 .attempts-display{margin-bottom:6px;font-size:1.1em}
 .heart{color:#ff6b6b;transition:all .3s}
 .heart.lost{color:#ddd;transform:scale(.8)}
 .streak-badge{display:inline-block;background:linear-gradient(135deg,#fd79a8,#e84393);color:white;padding:4px 12px;border-radius:20px;font-weight:700;font-size:.8em;margin-bottom:10px}
 .streak-badge.hot{background:linear-gradient(135deg,#ff6b6b,#ee5a24);animation:pulse 1s infinite}
 .celebration .trophy{font-size:70px;animation:bounce 1s infinite}
 .final-score{font-weight:800;font-size:1.6em;color:#6c5ce7;margin:12px 0}
 .stars-display{font-size:36px;margin:10px 0}
 .results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin:12px 0;max-height:180px;overflow-y:auto;padding:6px}
 .result-item{padding:8px;border-radius:10px;font-weight:700;font-size:.85em}
 .result-item.got-right{background:#d5f5e3;color:#00b894}
 .result-item.got-wrong{background:#ffe0e0;color:#e74c3c}
 .result-emoji{font-size:1.4em}
 .confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;overflow:hidden}
 .confetti-piece{position:absolute;width:10px;height:20px;top:-20px;animation:confettiFall linear forwards}
 @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
 /* ===== FRACTION TEACHER (wrapped for hub) ===== */
 .fraction-card{background:white;padding:20px;border-radius:20px;max-width:900px;margin:auto;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center}
 .bar{display:flex;margin:10px 0;justify-content:center}
 .piece{height:40px;border:1px solid #333;flex:1;margin:2px;border-radius:4px;background:#eee;transition:.3s}
 .filled1{background:#ff8fab}
 .filled2{background:#8ecae6}
 .dropzone{border:2px dashed #555;min-height:60px;padding:10px;margin:20px auto;max-width:500px;border-radius:10px}
 .draggable{display:inline-block;padding:10px;background:#90dbf4;margin:5px;border-radius:6px;cursor:grab}
 .frac-btn{padding:10px 15px;margin:10px;border-radius:15px;border:none;background:#ff8fab;color:white;font-size:16px;cursor:pointer}
 .stepText{margin-top:15px;font-weight:bold}
 @media(max-width:600px){
  .big-title{font-size:1.5em}
  .question-display{font-size:1.9em}
  .answer-input{font-size:1.3em;width:115px}
  .lane-label{width:50px;font-size:.55em}
  .racer-icon{font-size:1.1em}.human-lane .racer-icon{font-size:1.25em}
  .results-stats,.shop-results-stats{grid-template-columns:1fr 1fr}
  .ai-config-grid{grid-template-columns:1fr}
  .room-code-display{font-size:1.6em;letter-spacing:4px}
  .mode-btn{min-width:150px;padding:12px 18px;font-size:.95em}
  .card{padding:16px}
  .game-card{width:100%}
  .market-mode{width:100%}
  .shelf-items{grid-template-columns:repeat(3,1fr)}
  .countdown-number{font-size:4em}
  .spell-title{font-size:1.6em}
  .emoji-display{font-size:70px}
 }
 @media(max-width:380px){
  .question-display{font-size:1.6em}
  .answer-input{font-size:1.1em;width:100px}
  .shelf-items{grid-template-columns:repeat(2,1fr)}
 }
 </style>
</head>
<body>
<div class="stars-bg" id="starsBg"></div>
<div class="celebration-layer" id="celebrationLayer"></div>
<div class="countdown-overlay" id="countdownOverlay"><div class="countdown-number" id="countdownNum">3</div></div>
<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text" id="loadingText">Connecting...</div></div>
<div class="conn-status" id="connStatus"></div>
<div class="confetti-container" id="confettiContainer"></div>

<div class="container">
 <!-- ===== GAME HUB ===== -->
 <div class="screen active" id="hubScreen">
  <div class="card">
   <span class="hub-mascot">üéÆ</span>
   <h1 class="big-title" style="color:var(--purple)">Adventure Hub</h1>
   <p class="sub-text">Pick a game and start learning!</p>
   <div class="game-cards">
    <div class="game-card" onclick="launchGame('race')">
     <span class="gc-icon">üèéÔ∏è</span>
     <div class="gc-title">Math Race</div>
     <div class="gc-desc">Race against AI & friends! Answer questions to speed ahead.</div>
     <span class="gc-tag gc-tag-race">Multiplayer ‚Ä¢ Solo</span>
    </div>
    <div class="game-card" onclick="launchGame('market')">
     <span class="gc-icon">üõí</span>
     <div class="gc-title">Math Market</div>
     <div class="gc-desc">Run a shop! Buy, sell, calculate totals & make change.</div>
     <span class="gc-tag gc-tag-shop">Solo ‚Ä¢ Story Mode</span>
    </div>
    <div class="game-card" onclick="launchGame('spelling')">
     <span class="gc-icon">üêù</span>
     <div class="gc-title">Spelling Bee</div>
     <div class="gc-desc">Listen, look, and spell fun words with hints and emojis.</div>
     <span class="gc-tag gc-tag-spell">Words ‚Ä¢ Audio</span>
    </div>
    <div class="game-card" onclick="launchGame('fraction')">
     <span class="gc-icon">‚ûó</span>
     <div class="gc-title">Visual Fractions</div>
     <div class="gc-desc">See fraction bars and drag pieces to add fractions.</div>
     <span class="gc-tag gc-tag-frac">Fractions ‚Ä¢ Visual</span>
    </div>
   </div>
  </div>
 </div>

 <!-- ===== RACE: ALL SCREENS ===== -->
 <div class="screen" id="raceHomeScreen"><div class="card">
  <button class="back-btn" onclick="showHub()">‚Üê Game Hub</button>
  <span style="font-size:60px;display:block;animation:bounce 2s infinite;margin-bottom:8px">üèéÔ∏è</span>
  <h1 class="big-title" style="color:var(--red)">Math Race!</h1>
  <p class="sub-text">Race against AI and friends!</p>
  <div class="mode-buttons">
   <button class="mode-btn mode-solo" onclick="raceGoSetup('solo')">Solo Race<br><small>Play vs AI</small></button>
   <button class="mode-btn mode-host" onclick="raceGoSetup('host')">Host Room<br><small>Multiplayer</small></button>
   <button class="mode-btn mode-join" onclick="raceShowScreen('raceJoinScreen')">Join Room<br><small>Enter code</small></button>
  </div>
 </div></div>
 <div class="screen" id="raceSetupScreen"><div class="card" id="raceSetupCard"></div></div>
 <div class="screen" id="raceJoinScreen"><div class="card" id="raceJoinCard"></div></div>
 <div class="screen" id="raceLobbyScreen"><div class="card" id="raceLobbyCard"></div></div>
 <div class="screen" id="raceGameScreen" style="animation:none"></div>
 <div class="screen" id="raceResultsScreen"><div class="card" id="raceResultsCard"></div></div>

 <!-- ===== MARKET: ALL SCREENS ===== -->
 <div class="screen" id="marketHomeScreen"><div class="card">
  <button class="back-btn" onclick="showHub()">‚Üê Game Hub</button>
  <span style="font-size:55px;display:block;animation:bounce 2s infinite;margin-bottom:8px">üõí</span>
  <h1 class="big-title" style="color:var(--green)">Math Market!</h1>
  <p class="sub-text">Welcome to your very own shop!</p>
  <label class="field-label" style="text-align:center;margin-left:0">Your Name</label>
  <input type="text" id="marketName" class="text-input" placeholder="Type your name..." maxlength="12" autocomplete="off">
  <h3 class="section-title">Settings</h3>
  <div class="config-panel" id="marketConfigPanel">
   <div class="config-title">Game Configuration</div>
   <div class="config-row">
    <span class="config-label">Use Cents (e.g. $1.20)</span>
    <button class="config-toggle" id="cfgCents" onclick="mToggleConfig('cents')"></button>
   </div>
   <div class="config-row">
    <span class="config-label">Difficulty</span>
    <div class="option-grid" id="cfgDiffGrid" style="margin:0"></div>
   </div>
   <div class="config-row" id="cfgCashierShowRow">
    <span class="config-label">Cashier: Show item costs</span>
    <button class="config-toggle active" id="cfgCashierShow" onclick="mToggleConfig('cashierShow')"></button>
   </div>
  </div>
  <h3 class="section-title">Choose a Mode</h3>
  <div class="market-modes" id="marketModes">
   <div class="market-mode" onclick="startMarketMode('shopper')">
    <span class="mm-icon">üß∫</span>
    <div class="mm-title">Shopper</div>
    <div class="mm-desc">Buy items, calculate totals & change</div>
   </div>
   <div class="market-mode" onclick="startMarketMode('cashier')">
    <span class="mm-icon">üíµ</span>
    <div class="mm-title">Cashier</div>
    <div class="mm-desc">Help customers & give correct change</div>
   </div>
   <div class="market-mode" onclick="startMarketMode('owner')">
    <span class="mm-icon">üè™</span>
    <div class="mm-title">Shop Owner</div>
    <div class="mm-desc">Manage stock, sales & daily earnings</div>
   </div>
  </div>
 </div></div>
 <div class="screen" id="marketGameScreen"></div>
 <div class="screen" id="marketResultsScreen"><div class="card" id="marketResultsCard"></div></div>

 <!-- ===== SPELLING BEE: ALL SCREENS (wrapped) ===== -->
 <div class="screen" id="spellingScreen">
  <div class="spell-app-container">
   <button class="back-btn" style="position:absolute;left:18px;top:14px" onclick="goToHubFromSpelling()">‚Üê Game Hub</button>

   <!-- START SCREEN -->
   <div class="spell-screen active" id="startScreen">
    <div class="start-screen">
     <div class="bee-icon">üêù</div>
     <h2 class="spell-title">Spelling Bee!</h2>
     <p class="spell-subtitle">Let's learn to spell amazing words!</p>
     <div class="category-title">Pick a Category:</div>
     <div class="category-grid" id="categoryGrid"></div>
     <div class="category-title">Pick Difficulty:</div>
     <div class="difficulty-selector">
      <button class="diff-btn selected" onclick="setDifficulty('easy')" id="diffEasy">Easy</button>
      <button class="diff-btn" onclick="setDifficulty('medium')" id="diffMedium">Medium</button>
      <button class="diff-btn" onclick="setDifficulty('hard')" id="diffHard">Hard</button>
     </div>
     <br>
     <button class="start-btn" id="startBtn" onclick="startGame()" disabled>Let's Go!</button>
    </div>
   </div>

   <!-- GAME SCREEN -->
   <div class="spell-screen" id="gameScreen">
    <h2 class="spell-title">Spelling Bee!</h2>
    <div class="progress-container">
     <div class="progress-bar" id="progressBar" style="width:0%"></div>
     <span class="progress-text" id="progressText">1 / 10</span>
    </div>
    <div class="score-display">
     <div class="score-item">
      <span class="icon">‚úÖ</span>
      <span id="correctCount">0</span>
     </div>
     <div class="score-item">
      <span class="icon">‚ùå</span>
      <span id="wrongCount">0</span>
     </div>
     <div id="streakContainer" class="streak-badge" style="display:none;">
      Streak: <span id="streakCount">0</span>
     </div>
    </div>
    <div class="image-container" id="imageContainer">
     <span class="emoji-display" id="wordEmoji">‚ùì</span>
     <button class="sound-btn" onclick="speakWord()" id="soundBtn">Hear the Word</button>
    </div>
    <div class="attempts-display" id="attemptsDisplay"></div>
    <div class="letter-boxes" id="letterBoxes"></div>
    <div class="input-area">
     <input type="text" class="spell-input" id="spellInput" placeholder="Type here..." autocomplete="off" autocapitalize="off" spellcheck="false">
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="word-info" id="wordInfo"></div>
    <div class="btn-group" id="actionButtons">
     <button class="action-btn check-btn" onclick="checkAnswer()" id="checkBtn">Check</button>
     <button class="action-btn hint-btn" onclick="giveHint()" id="hintBtn">Hint</button>
     <button class="action-btn skip-btn" onclick="skipWord()" id="skipBtn">Skip</button>
    </div>
    <div class="btn-group" id="nextBtnContainer" style="display:none;">
     <button class="action-btn next-btn" onclick="nextWord()">Next Word</button>
    </div>
   </div>

   <!-- RESULTS SCREEN -->
   <div class="spell-screen" id="resultsScreen">
    <div class="celebration active">
     <div class="trophy" id="trophyIcon">üèÜ</div>
     <h2 id="resultsTitle">Great Job!</h2>
     <div class="final-score" id="finalScore">0 / 10</div>
     <div class="stars-display" id="starsDisplay"></div>
     <p class="spell-subtitle" id="resultsMessage"></p>
     <div class="results-grid" id="resultsGrid"></div>
     <button class="start-btn" onclick="goToStart()">Play Again!</button>
    </div>
   </div>
  </div>
 </div>

 <!-- ===== FRACTION GAME SCREEN ===== -->
 <div class="screen" id="fractionScreen">
  <div class="fraction-card">
   <button class="back-btn" onclick="showHub()">‚Üê Game Hub</button>
   <h2 style="margin-top:5px">Visual Fraction Teacher</h2>
   <div id="question" style="font-size:22px;margin-top:8px;"></div>
   <div id="bars"></div>
   <div id="draggableArea"></div>
   <div class="dropzone" id="dropzone">Drag pieces here to add</div>
   <div class="stepText" id="stepText"></div>
   <button class="frac-btn" onclick="nextStep()">Next Step</button>
   <button class="frac-btn" onclick="newQuestion()">New Question</button>
  </div>
 </div>
</div>

<!-- Firebase (for Math Race) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================================================================
// SHARED UTILITIES + HUB
// ================================================================
const FIREBASE_CONFIG={
 apiKey:"AIzaSyAxcCeFU2XOIV0H2DjLFZXOrgtbCTbmg9c",
 authDomain:"math-race-6c1bd.firebaseapp.com",
 databaseURL:"https://math-race-6c1bd-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"math-race-6c1bd",
 storageBucket:"math-race-6c1bd.firebasestorage.app",
 messagingSenderId:"775711322840",
 appId:"1:775711322840:web:90c786ece15f01e19f5dad"
};
let firebaseReady=false,db=null;
async function initFirebase(){
 if(firebaseReady&&db)return true;
 showLoading('Connecting...');
 try{
  if(typeof firebase==='undefined'){
   hideLoading();toast('No internet. Refresh page.','error');return false;
  }
  if(!firebase.apps||firebase.apps.length===0)firebase.initializeApp(FIREBASE_CONFIG);
  db=firebase.database();
  const c=await new Promise(r=>{
   let done=false;
   const t=setTimeout(()=>{if(!done){done=true;r(false)}},8000);
   db.ref('.info/connected').on('value',s=>{
    const e=$('connStatus');
    if(s.val()===true){
     e.className='conn-status online';e.textContent='Online';
     if(!done){done=true;clearTimeout(t);r(true)}
    }else{
     e.className='conn-status offline';e.textContent='Connecting...';
    }
   });
   db.ref('.info/connected').once('value').then(()=>{
    if(!done){done=true;clearTimeout(t);r(true)}
   }).catch(()=>{if(!done){done=true;clearTimeout(t);r(false)}});
  });
  hideLoading();
  if(c){firebaseReady=true;return true}
  toast('Cannot connect. Check internet.','error');return false;
 }catch(e){hideLoading();toast('Error: '+e.message,'error');return false}
}
function disconnectFirebase(){
 if(db&&R.roomRef&&R.myId){try{R.roomRef.child('players/'+R.myId).remove()}catch(e){}}
 R.unsubscribers.forEach(fn=>{try{fn()}catch(e){}});R.unsubscribers=[];R.roomRef=null;
 $('connStatus').style.display='none';
}
function $(id){return document.getElementById(id)}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function showScreen(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
 const el=$(id);el.classList.remove('active');void el.offsetWidth;el.classList.add('active');
 window.scrollTo(0,0);
}
function confetti(n){
 const c=$('celebrationLayer');
 const cols=['#e74c3c','#f39c12','#2ecc71','#3498db','#9b59b6','#e84393','#fdcb6e','#00cec9'];
 for(let i=0;i<n;i++){
  setTimeout(()=>{
   const p=document.createElement('div');
   p.className='confetti-piece';
   p.style.left=Math.random()*100+'%';
   p.style.top='-10px';
   p.style.backgroundColor=cols[rand(0,cols.length-1)];
   p.style.animationDuration=(2+Math.random()*3)+'s';
   p.style.width=(6+Math.random()*10)+'px';
   p.style.height=(6+Math.random()*10)+'px';
   p.style.borderRadius=Math.random()>.5?'50%':'2px';
   c.appendChild(p);setTimeout(()=>p.remove(),5000);
  },i*70);
 }
}
function floatTxt(t,c){
 const el=document.createElement('div');
 el.className='float-text';el.textContent=t;el.style.color=c||'white';
 document.body.appendChild(el);setTimeout(()=>el.remove(),1800);
}
function toast(m,t){
 const e=document.querySelector('.toast');if(e)e.remove();
 const d=document.createElement('div');d.className='toast '+(t||'');d.textContent=m;
 document.body.appendChild(d);setTimeout(()=>d.remove(),3500);
}
function runCountdown(cb){
 const ov=$('countdownOverlay'),ne=$('countdownNum');
 ov.classList.add('active');let c=3;ne.textContent=c;ne.style.color='white';
 ne.style.animation='none';ne.offsetWidth;ne.style.animation='bounceIn .45s ease';
 const iv=setInterval(()=>{
  c--;
  if(c>0){
   ne.textContent=c;ne.style.animation='none';ne.offsetWidth;ne.style.animation='bounceIn .45s ease';
  }else if(c===0){
   ne.textContent='GO!';ne.style.color='#00b894';ne.style.animation='none';ne.offsetWidth;
   ne.style.animation='bounceIn .45s ease';
  }else{
   clearInterval(iv);ov.classList.remove('active');cb();
  }
 },800);
}
function showLoading(t){$('loadingText').textContent=t||'Loading...';$('loadingOverlay').classList.add('active')}
function hideLoading(){$('loadingOverlay').classList.remove('active')}
// Format price based on cents config
function mFmtPrice(val){if(M.useCents)return '$'+val.toFixed(2);return '$'+Math.round(val);}
function mRound(val){return Math.round(val*100)/100}

// Stars BG
(function(){const bg=$('starsBg');const sy=['‚ú®','‚≠ê','üåü','üí´'];for(let i=0;i<12;i++){const s=document.createElement('span');s.className='floating-star';s.textContent=sy[i%sy.length];s.style.left=Math.random()*100+'%';s.style.fontSize=(10+Math.random()*12)+'px';s.style.animationDuration=(10+Math.random()*15)+'s';s.style.animationDelay=Math.random()*12+'s';bg.appendChild(s)}})();

// HUB
function showHub(){raceCleanup();showScreen('hubScreen')}
function launchGame(game){
 if(game==='race')showScreen('raceHomeScreen');
 else if(game==='market'){mInitConfigUI();showScreen('marketHomeScreen');}
 else if(game==='spelling'){showScreen('spellingScreen');}
 else if(game==='fraction'){showScreen('fractionScreen');}
}

// ================================================================
// GAME 1: MATH RACE (unchanged logic)
// ================================================================
const RACERS=['üöó','üöï','üöô','üõª','üèéÔ∏è','üöì','üöë','üöí','üöú','üõ∫','üöå','üöé','üöÇ','üöÄ'];
const DEFAULT_AI=[{name:'Turbo Tina',emoji:'üê∞',speed:95},{name:'Speedy Sam',emoji:'üêÜ',speed:70},{name:'Steady Eddie',emoji:'üê¢',speed:45},{name:'Slowpoke Sue',emoji:'üêå',speed:25}];
const RACE_TOPICS=[{id:'add',label:'Add',cls:'opt-easy'},{id:'sub',label:'Sub',cls:'opt-medium'},{id:'mul',label:'Mul',cls:'opt-easy'},{id:'div',label:'Div',cls:'opt-hard'},{id:'all',label:'All',cls:'opt-medium'}];
const RACE_DIFFS=[{id:'easy',label:'Easy',cls:'opt-easy'},{id:'medium',label:'Medium',cls:'opt-medium'},{id:'hard',label:'Hard',cls:'opt-hard'}];
const RACE_LENS=[{id:10,label:'10 Qs'},{id:15,label:'15 Qs'},{id:20,label:'20 Qs'}];
const CHEERS=["Amazing! üéâ","Super! üåü","Brilliant! üí°","On fire! üî•","Wow! ü§©","Fantastic! üéà","Way to go! üôå","Math star! üå†"];
let R={mode:'solo',myId:'p_'+Math.random().toString(36).substr(2,9),name:'',racerEmoji:'üöó',topic:'',diff:'',totalQs:15,aiConfig:DEFAULT_AI.map(a=>({...a})),roomCode:'',roomRef:null,isHost:false,qIndex:0,correct:0,wrong:0,streak:0,bestStreak:0,progress:0,timerSec:0,timerIntv:null,aiProgress:[],aiIntv:null,aiFinishTimes:[],currentQ:null,answered:false,raceFinished:false,finishOrder:[],wrongList:[],autoNextTimer:null,sharedQuestions:null,roomData:null,unsubscribers:[],raceStartTime:0,playerFinishTime:0};
function raceReset(){R={mode:'solo',myId:'p_'+Math.random().toString(36).substr(2,9),name:'',racerEmoji:'üöó',topic:'',diff:'',totalQs:15,aiConfig:DEFAULT_AI.map(a=>({...a})),roomCode:'',roomRef:null,isHost:false,qIndex:0,correct:0,wrong:0,streak:0,bestStreak:0,progress:0,timerSec:0,timerIntv:null,aiProgress:[],aiIntv:null,aiFinishTimes:[],currentQ:null,answered:false,raceFinished:false,finishOrder:[],wrongList:[],autoNextTimer:null,sharedQuestions:null,roomData:null,unsubscribers:[],raceStartTime:0,playerFinishTime:0}}
function raceCleanup(){clearInterval(R.timerIntv);clearInterval(R.aiIntv);clearTimeout(R.autoNextTimer);R.unsubscribers.forEach(fn=>{try{fn()}catch(e){}});R.unsubscribers=[];disconnectFirebase();raceReset()}
function raceShowScreen(id){showScreen(id)}
function raceGoSetup(mode){R.mode=mode;R.isHost=(mode==='host');buildRaceSetup();showScreen('raceSetupScreen')}
function buildRaceSetup(){
 const c=$('raceSetupCard');
 c.innerHTML=`<button class="back-btn" onclick="showScreen('raceHomeScreen')">‚Üê Back</button>
 <h2 class="section-title">${R.isHost?'Host Setup':'Solo Setup'}</h2>
 <label class="field-label">Name</label><input type="text" id="rName" class="text-input" placeholder="Your name..." maxlength="12" autocomplete="off">
 <h3 class="section-title">Racer</h3><div class="racer-picker" id="rRacerPick"></div>
 <h3 class="section-title">Topic</h3><div class="option-grid" id="rTopicGrid"></div>
 <h3 class="section-title">Difficulty</h3><div class="option-grid" id="rDiffGrid"></div>
 <h3 class="section-title">Length</h3><div class="option-grid" id="rLenGrid"></div>
 <h3 class="section-title">AI Speed (0=Off, 100=~2s/question)</h3><div class="ai-config-grid" id="rAIGrid"></div>
 <button class="big-btn btn-red" id="rGoBtn" onclick="raceSetupGo()" disabled>${R.isHost?'Create Room!':'Start Race!'}</button>`;
 buildPicker('rRacerPick',RACERS,(em)=>{R.racerEmoji=em;rChk()});
 buildOptGrid2('rTopicGrid',RACE_TOPICS,(id)=>{R.topic=id;rChk()});
 buildOptGrid2('rDiffGrid',RACE_DIFFS,(id)=>{R.diff=id;rChk()});
 buildOptGrid2('rLenGrid',RACE_LENS.map(l=>({id:l.id,label:l.label,cls:'opt-medium'})),id=>{R.totalQs=parseInt(id);},1);
 R.totalQs=15;buildAIGrid();$('rName').addEventListener('input',rChk);
 $('rName').addEventListener('keydown',e=>{if(e.key==='Enter')raceSetupGo()});
}
function buildPicker(cid,items,cb){const c=$(cid);c.innerHTML='';items.forEach((em,i)=>{const d=document.createElement('div');d.className='racer-option'+(i===0?' selected':'');d.textContent=em;if(i===0)cb(em);d.onclick=()=>{c.querySelectorAll('.racer-option').forEach(x=>x.classList.remove('selected'));d.classList.add('selected');cb(em)};c.appendChild(d)})}
function buildOptGrid2(cid,opts,cb,defIdx){const c=$(cid);c.innerHTML='';opts.forEach((o,i)=>{const b=document.createElement('button');b.className='option-btn '+(o.cls||'opt-medium')+(i===defIdx?' selected':'');b.textContent=o.label;if(i===defIdx)cb(o.id);b.onclick=()=>{c.querySelectorAll('.option-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');cb(o.id);rChk()};c.appendChild(b)})}
function buildAIGrid(){const c=$('rAIGrid');c.innerHTML='';R.aiConfig=DEFAULT_AI.map(a=>({...a}));R.aiConfig.forEach((ai,i)=>{const d=document.createElement('div');d.className='ai-card';d.innerHTML=`<div class="ai-card-header"><span class="ai-card-emoji">${ai.emoji}</span><span class="ai-card-name">${ai.name}</span></div><label>Speed: <span class="ai-speed-label" id="ras${i}">${ai.speed}%</span></label><input type="range" class="ai-slider" min="0" max="100" value="${ai.speed}" oninput="R.aiConfig[${i}].speed=parseInt(this.value);$('ras${i}').textContent=this.value==0?'OFF':this.value+'%'">`;c.appendChild(d)})}
function rChk(){const n=$('rName');$('rGoBtn').disabled=!(n&&n.value.trim().length>0&&R.topic&&R.diff)}
async function raceSetupGo(){
 R.name=$('rName').value.trim();if(!R.name||!R.topic||!R.diff)return;
 if(R.mode==='solo'){
  R.sharedQuestions=rGenAllQs();rInitGame();showScreen('raceGameScreen');
  runCountdown(()=>{rBuildTrack();rBegin()});
 }else{
  const ok=await initFirebase();if(!ok)return;
  R.roomCode=rGenCode();
  const rd={code:R.roomCode,hostId:R.myId,settings:{topic:R.topic,diff:R.diff,totalQs:R.totalQs,aiConfig:R.aiConfig.map(a=>({name:a.name,emoji:a.emoji,speed:a.speed}))},state:'lobby',players:{},questions:rGenAllQs(),startTime:null};
  rd.players[R.myId]={name:R.name,emoji:R.racerEmoji,isHost:true,progress:0,correct:0,wrong:0,finished:false,finishTime:null,qIndex:0};
  R.roomRef=db.ref('rooms/'+R.roomCode);
  try{
   await R.roomRef.set(rd);
   R.roomRef.child('players/'+R.myId).onDisconnect().remove();
   rListenRoom();rBuildLobby();showScreen('raceLobbyScreen');
   toast('Room created!','success');
  }catch(e){toast('Error: '+e.message,'error')}
 }
}
function rGenCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<4;i++)r+=c[rand(0,c.length-1)];return r}
function rBuildJoin(){const c=$('raceJoinCard');c.innerHTML=`<button class="back-btn" onclick="showScreen('raceHomeScreen')">‚Üê Back</button><span style="font-size:45px;display:block;margin-bottom:8px">üèÅ</span><h2 class="section-title">Join Room</h2><label class="field-label">Name</label><input type="text" id="rjName" class="text-input" placeholder="Name..." maxlength="12" autocomplete="off"><h3 class="section-title">Racer</h3><div class="racer-picker" id="rjPick"></div><h3 class="section-title">Code</h3><input type="text" id="rjCode" class="text-input join-input" placeholder="ABCD" maxlength="4" autocomplete="off"><br><button class="big-btn btn-green" id="rjBtn" onclick="rJoinRoom()" disabled>Join!</button>`;buildPicker('rjPick',RACERS,em=>{R.racerEmoji=em});$('rjName').addEventListener('input',rjChk);$('rjCode').addEventListener('input',function(){this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');rjChk()});$('rjCode').addEventListener('keydown',e=>{if(e.key==='Enter')rJoinRoom()})}
(function(){setTimeout(()=>{rBuildJoin()},0)})();
function rjChk(){$('rjBtn').disabled=!($('rjName').value.trim().length>0&&$('rjCode').value.trim().length===4)}
async function rJoinRoom(){
 R.name=$('rjName').value.trim();R.roomCode=$('rjCode').value.trim().toUpperCase();
 if(!R.name||R.roomCode.length!==4)return;
 const ok=await initFirebase();if(!ok)return;
 R.roomRef=db.ref('rooms/'+R.roomCode);R.mode='join';R.isHost=false;
 try{
  showLoading('Joining...');const s=await R.roomRef.once('value');const d=s.val();hideLoading();
  if(!d){toast('Room not found!','error');return}
  if(d.state!=='lobby'){toast('Already started!','error');return}
  const names=Object.values(d.players||{}).map(p=>p.name.toLowerCase());
  if(names.includes(R.name.toLowerCase())){toast('Name taken!','error');return}
  R.topic=d.settings.topic;R.diff=d.settings.diff;R.totalQs=d.settings.totalQs;R.aiConfig=(d.settings.aiConfig||[]).map(a=>({...a}));
  await R.roomRef.child('players/'+R.myId).set({name:R.name,emoji:R.racerEmoji,isHost:false,progress:0,correct:0,wrong:0,finished:false,finishTime:null,qIndex:0});
  R.roomRef.child('players/'+R.myId).onDisconnect().remove();
  rListenRoom();rBuildLobby();showScreen('raceLobbyScreen');toast('Joined!','success');
 }catch(e){hideLoading();toast('Error: '+e.message,'error')}
}
function rBuildLobby(){
 $('raceLobbyCard').innerHTML=`<span style="font-size:45px;display:block;margin-bottom:6px">üèÅ</span><h2 class="section-title">Lobby</h2><p style="color:#888;font-size:.85em">Share code:</p><div class="room-code-display" id="rLobbyCode" onclick="rCopyCode()">${R.roomCode}</div><p class="copy-hint">Tap to copy!</p><h3 class="section-title">Players</h3><div class="players-lobby" id="rLobbyPlayers"></div><h3 class="section-title">AI</h3><div class="lobby-ai-list" id="rLobbyAI"></div><p class="lobby-status" id="rLobbyStatus">Waiting...<span class="waiting-dots"></span></p><button class="big-btn btn-red" id="rLobbyStart" onclick="rHostStart()" style="display:none">Start!</button><br><button class="back-btn" onclick="rLeaveLobby()" style="margin-top:10px">Leave</button>`;
}
function rCopyCode(){
 if(navigator.clipboard)navigator.clipboard.writeText(R.roomCode).then(()=>toast('Copied! '+R.roomCode,'success')).catch(()=>toast('Code: '+R.roomCode,'success'));
 else toast('Code: '+R.roomCode,'success');
}
function rLeaveLobby(){raceCleanup();showScreen('raceHomeScreen')}
function rListenRoom(){
 const h=R.roomRef.on('value',s=>{
  const d=s.val();if(!d){toast('Room closed.','error');raceCleanup();showScreen('raceHomeScreen');return}
  R.roomData=d;rUpdateLobby(d);
  if(d.state==='countdown'&&$('raceLobbyScreen').classList.contains('active'))rStartMPCountdown(d);
  if(d.state==='racing'&&$('raceGameScreen').classList.contains('active'))rUpdateMPTrack(d);
  if(d.state==='finished'&&!R.raceFinished){
   R.raceFinished=true;clearInterval(R.timerIntv);clearInterval(R.aiIntv);clearTimeout(R.autoNextTimer);
   setTimeout(()=>rShowMPResults(d),800);
  }
 });
 R.unsubscribers.push(()=>R.roomRef.off('value',h));
}
function rUpdateLobby(d){
 const pe=$('rLobbyPlayers');if(!pe)return;pe.innerHTML='';
 Object.entries(d.players||{}).forEach(([id,p])=>{
  const div=document.createElement('div');
  div.className='lobby-player'+(p.isHost?' is-host':'');
  div.innerHTML=`<span class="lp-emoji">${p.emoji}</span><span class="lp-name">${p.name}</span>${p.isHost?'<span class="lp-tag">HOST</span>':''}`;
  pe.appendChild(div);
 });
 const ae=$('rLobbyAI');if(ae){ae.innerHTML='';(d.settings.aiConfig||[]).forEach(ai=>{if(ai.speed>0){const div=document.createElement('div');div.className='lobby-ai';div.textContent=`${ai.emoji} ${ai.name} (${ai.speed}%)`;ae.appendChild(div)}})}
 if(R.isHost){
  const btn=$('rLobbyStart');if(btn)btn.style.display='inline-block';
  const st=$('rLobbyStatus');if(st)st.innerHTML=Object.keys(d.players).length+' players ready.';
 }
}
async function rHostStart(){if(!R.isHost||!R.roomRef)return;try{await R.roomRef.update({state:'countdown',startTime:firebase.database.ServerValue.TIMESTAMP})}catch(e){toast('Error: '+e.message,'error')}}
function rStartMPCountdown(d){
 R.topic=d.settings.topic;R.diff=d.settings.diff;R.totalQs=d.settings.totalQs;R.aiConfig=(d.settings.aiConfig||[]).map(a=>({...a}));R.sharedQuestions=d.questions||[];
 rInitGame();showScreen('raceGameScreen');
 runCountdown(async()=>{rBuildTrack();if(R.isHost){try{await R.roomRef.update({state:'racing'})}catch(e){}}rBegin()});
}
function rInitGame(){
 R.qIndex=0;R.correct=0;R.wrong=0;R.streak=0;R.bestStreak=0;R.progress=0;R.timerSec=0;R.raceFinished=false;R.finishOrder=[];R.wrongList=[];R.answered=false;R.aiProgress=R.aiConfig.map(()=>0);R.aiFinishTimes=R.aiConfig.map(()=>0);R.raceStartTime=0;R.playerFinishTime=0;
 $('raceGameScreen').innerHTML=`<div class="game-top-bar"><div class="player-info" id="rgName">${R.name}</div><div class="timer-display" id="rgTimer">‚è± 0:00</div><div class="stats-bar"><div class="stat">‚úÖ <span id="rgC">0</span></div><div class="stat">‚ùå <span id="rgW">0</span></div><div class="stat">üî• <span id="rgS">0</span></div></div></div><div class="race-track-wrapper"><div class="race-track-title">RACE TRACK</div><div id="rgTrack"></div></div><div class="question-card" id="rgQCard"><div class="q-number" id="rgQN">Q1</div><span class="q-type-badge" id="rgQB">Add</span><div class="question-display"><span id="rgN1">0</span> <span class="q-op" id="rgOp">+</span> <span id="rgN2">0</span> <span class="q-op">=</span> <span class="q-op">?</span></div><div class="answer-row"><input type="number" id="rgAns" class="answer-input" placeholder="?" autocomplete="off" inputmode="numeric"><button class="submit-btn" id="rgSub" onclick="rCheckAns()">Go!</button></div><div class="feedback-area" id="rgFB"></div><div class="hint-box" id="rgHint"></div></div>`;
 $('rgAns').addEventListener('keydown',e=>{if(e.key==='Enter'&&!R.answered)rCheckAns()});
 $('rgAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9\-]/g,'')});
}
function rBuildTrack(){
 const t=$('rgTrack');t.innerHTML='';
 t.appendChild(rMkLane(R.name,R.racerEmoji,'human-lane','myR'));
 if(R.mode!=='solo'&&R.roomData)Object.entries(R.roomData.players||{}).forEach(([id,p])=>{if(id!==R.myId)t.appendChild(rMkLane(p.name,p.emoji,'human-lane','r_'+id))});
 R.aiConfig.forEach((ai,i)=>{if(ai.speed>0)t.appendChild(rMkLane(ai.name,ai.emoji,'ai-lane','aiR'+i))});
}
function rMkLane(n,e,c,id){
 const l=document.createElement('div');l.className='race-lane';
 const lb=document.createElement('div');lb.className='lane-label';lb.textContent=n;
 const tk=document.createElement('div');tk.className='lane-track '+c;
 [25,50,75].forEach(p=>{const cp=document.createElement('span');cp.className='checkpoint';cp.style.left=p+'%';cp.textContent='üèÅ';tk.appendChild(cp)});
 const rc=document.createElement('span');rc.className='racer-icon';rc.id=id;rc.textContent=e;rc.style.left='1%';tk.appendChild(rc);
 const fl=document.createElement('span');fl.className='finish-flag';fl.textContent='üèÅ';tk.appendChild(fl);
 l.appendChild(lb);l.appendChild(tk);return l;
}
function rMoveR(id,p){
 const el=$(id);if(!el)return;
 el.style.left=1+(Math.min(100,p)/100)*87+'%';
 el.classList.remove('moving');void el.offsetWidth;el.classList.add('moving');
 setTimeout(()=>el.classList.remove('moving'),800);
}
function rBegin(){
 R.raceStartTime=Date.now();
 R.timerIntv=setInterval(()=>{
  if(R.raceFinished)return;
  R.timerSec++;const m=Math.floor(R.timerSec/60),s=R.timerSec%60;
  const d=$('rgTimer');if(d)d.textContent='‚è± '+m+':'+(s<10?'0':'')+s;
 },1000);
 R.aiIntv=setInterval(()=>{
  if(R.raceFinished)return;
  R.aiConfig.forEach((ai,i)=>{
   if(ai.speed<=0||R.aiProgress[i]>=100)return;
   const inc=ai.speed/(4*R.totalQs)*(0.7+Math.random()*0.6);
   R.aiProgress[i]=Math.min(100,R.aiProgress[i]+inc);
   rMoveR('aiR'+i,R.aiProgress[i]);
   if(R.aiProgress[i]>=100&&!R.finishOrder.includes('ai_'+i)){
    R.aiFinishTimes[i]=Date.now();R.finishOrder.push('ai_'+i);rChkEnd();
   }
  });
 },500);
 rGenQ();
}
function rGenAllQs(){const qs=[];for(let i=0;i<30;i++)qs.push(rMkQ(R.topic,R.diff));return qs}
function rMkQ(topic,diff){
 let type=topic;if(type==='all'){const ts=['add','sub','mul','div'];type=ts[rand(0,3)]}
 let n1,n2,answer,opSymbol;
 switch(type){
  case'add':
   opSymbol='+';if(diff==='easy'){n1=rand(1,10);n2=rand(1,10)}else if(diff==='medium'){n1=rand(10,50);n2=rand(10,50)}else{n1=rand(50,200);n2=rand(25,200)}answer=n1+n2;break;
  case'sub':
   opSymbol='‚àí';if(diff==='easy'){n1=rand(5,15);n2=rand(1,n1-1)}else if(diff==='medium'){n1=rand(20,80);n2=rand(5,n1-1)}else{n1=rand(100,300);n2=rand(20,n1-1)}answer=n1-n2;break;
  case'mul':
   opSymbol='√ó';if(diff==='easy'){n1=rand(1,5);n2=rand(1,5)}else if(diff==='medium'){n1=rand(2,9);n2=rand(2,9)}else{n1=rand(4,12);n2=rand(6,15)}answer=n1*n2;break;
  case'div':
   opSymbol='√∑';if(diff==='easy'){n2=rand(1,5);answer=rand(1,5);n1=n2*answer}
   else if(diff==='medium'){n2=rand(2,9);answer=rand(2,9);n1=n2*answer}
   else{n2=rand(4,12);answer=rand(5,15);n1=n2*answer}break;
 }
 return{num1:n1,num2:n2,answer,opSymbol,type};
}
function rGenQ(){
 if(R.raceFinished)return;
 if(R.qIndex>=R.totalQs){rFinishP();return}
 clearTimeout(R.autoNextTimer);R.qIndex++;R.answered=false;
 let q;if(R.sharedQuestions&&R.sharedQuestions.length>=R.qIndex)q=R.sharedQuestions[R.qIndex-1];else q=rMkQ(R.topic,R.diff);
 R.currentQ=q;
 const tN={add:'Addition',sub:'Subtraction',mul:'Multiplication',div:'Division'};
 const tC={add:'badge-add',sub:'badge-sub',mul:'badge-mul',div:'badge-div'};
 const qn=$('rgQN');if(qn)qn.textContent='Q'+R.qIndex+'/'+R.totalQs;
 const bg=$('rgQB');if(bg){bg.textContent=tN[q.type];bg.className='q-type-badge '+tC[q.type]}
 const n1=$('rgN1');if(n1)n1.textContent=q.num1;
 const op=$('rgOp');if(op)op.textContent=q.opSymbol;
 const n2=$('rgN2');if(n2)n2.textContent=q.num2;
 const inp=$('rgAns');if(inp){inp.value='';inp.className='answer-input';inp.disabled=false;setTimeout(()=>inp.focus(),100)}
 const sb=$('rgSub');if(sb)sb.disabled=false;
 const fb=$('rgFB');if(fb)fb.innerHTML='';
 const ht=$('rgHint');if(ht)ht.style.display='none';
}
function rCheckAns(){
 if(R.answered||R.raceFinished)return;
 const inp=$('rgAns');if(!inp)return;
 const val=inp.value.trim();if(val===''){inp.className='answer-input wrong-flash';setTimeout(()=>inp.className='answer-input',500);return}
 const ua=parseInt(val);const q=R.currentQ;R.answered=true;inp.disabled=true;
 const sb=$('rgSub');if(sb)sb.disabled=true;
 if(ua===q.answer){
  R.correct++;R.streak++;if(R.streak>R.bestStreak)R.bestStreak=R.streak;
  inp.className='answer-input correct-flash';
  $('rgFB').innerHTML=`<span class="fb-emoji">üéâ</span><span class="fb-correct">${CHEERS[rand(0,CHEERS.length-1)]}</span>`;
  $('rgC').textContent=R.correct;$('rgS').textContent=R.streak;
  R.progress=Math.min(100,R.progress+100/R.totalQs);rMoveR('myR',R.progress);rSyncProg();
  confetti(5);floatTxt('+1 ‚≠ê','#fdcb6e');
  if(R.progress>=100){rFinishP();return}
  R.autoNextTimer=setTimeout(()=>{if(R.qIndex<R.totalQs&&!R.raceFinished)rGenQ();else if(!R.raceFinished)rFinishP()},1000);
 }else{
  R.wrong++;R.streak=0;inp.className='answer-input wrong-flash';
  R.wrongList.push({q:`${q.num1} ${q.opSymbol} ${q.num2}`,correct:q.answer,given:ua});
  const dir=ua<q.answer?'bigger':'smaller';
  $('rgFB').innerHTML=`<span class="fb-emoji">üòÖ</span><span class="fb-wrong">Answer: <strong>${q.answer}</strong> (too ${dir})</span>`;
  rShowHint(q);$('rgW').textContent=R.wrong;$('rgS').textContent=R.streak;rSyncProg();
  R.autoNextTimer=setTimeout(()=>{if(R.qIndex<R.totalQs&&!R.raceFinished)rGenQ();else if(!R.raceFinished)rFinishP()},2800);
 }
}
function rShowHint(q){
 const b=$('rgHint');if(!b)return;b.style.display='block';let h='<strong>Hint:</strong> ';
 switch(q.type){
  case'add':h+=`${q.num1}+${q.num2}=<strong>${q.answer}</strong>`;break;
  case'sub':h+=`${q.num1}‚àí${q.num2}=<strong>${q.answer}</strong>`;break;
  case'mul':let p=[];for(let i=1;i<=Math.min(q.num1,10);i++)p.push(q.num2*i);h+=`Skip count: `+p.join(', ')+` ‚Üí <strong>${q.answer}</strong>`;break;
  case'div':h+=`${q.num2}√ó<strong>${q.answer}</strong>=${q.num1}`;break;
 }
 b.innerHTML=h;
}
function rSyncProg(){if(R.mode==='solo'||!R.roomRef||!db)return;R.roomRef.child('players/'+R.myId).update({progress:R.progress,correct:R.correct,wrong:R.wrong,qIndex:R.qIndex}).catch(()=>{})}
function rUpdateMPTrack(d){if(!d.players)return;Object.entries(d.players).forEach(([id,p])=>{if(id!==R.myId)rMoveR('r_'+id,p.progress||0)})}
function rFinishP(){
 if(R.finishOrder.includes('player')||R.raceFinished)return;
 R.playerFinishTime=Date.now();R.finishOrder.push('player');R.progress=100;rMoveR('myR',100);
 clearTimeout(R.autoNextTimer);
 if(R.mode!=='solo'&&R.roomRef&&db)R.roomRef.child('players/'+R.myId).update({progress:100,finished:true,finishTime:firebase.database.ServerValue.TIMESTAMP,correct:R.correct,wrong:R.wrong}).catch(()=>{});
 setTimeout(()=>rChkEnd(),500);
}
function rChkEnd(){
 const pD=R.progress>=100||R.qIndex>=R.totalQs;
 const aiD=R.aiConfig.every((a,i)=>a.speed<=0||R.aiProgress[i]>=100);
 if(R.mode==='solo'){if(pD||aiD)rEndRace();}
 else if(R.isHost&&pD){
  const d=R.roomData;
  if(d){
   const allH=Object.values(d.players||{}).every(p=>p.finished||p.progress>=100);
   if(allH||aiD)R.roomRef.update({state:'finished'}).catch(()=>{});
  }
 }
}
function rEndRace(){
 if(R.raceFinished)return;R.raceFinished=true;clearInterval(R.timerIntv);clearInterval(R.aiIntv);clearTimeout(R.autoNextTimer);
 if(!R.playerFinishTime)R.playerFinishTime=Date.now();
 R.aiConfig.forEach((a,i)=>{if(a.speed>0&&!R.aiFinishTimes[i])R.aiFinishTimes[i]=Date.now()});
 if(!R.finishOrder.includes('player'))R.finishOrder.push('player');
 R.aiConfig.forEach((a,i)=>{if(a.speed>0&&!R.finishOrder.includes('ai_'+i))R.finishOrder.push('ai_'+i)});
 if(R.mode==='solo')setTimeout(()=>rShowResults(),1000);
}
function rShowResults(){
 const e=[];e.push({name:R.name,emoji:R.racerEmoji,progress:R.progress,isPlayer:true,isAI:false,finishTime:R.playerFinishTime||Infinity,finished:R.progress>=100});
 R.aiConfig.forEach((a,i)=>{if(a.speed>0)e.push({name:a.name,emoji:a.emoji,progress:R.aiProgress[i],isPlayer:false,isAI:true,finishTime:R.aiFinishTimes[i]||Infinity,finished:R.aiProgress[i]>=100})});
 e.sort((a,b)=>{if(a.finished&&b.finished)return a.finishTime-b.finishTime;if(a.finished&&!b.finished)return-1;if(!a.finished&&b.finished)return 1;return b.progress-a.progress});
 rDisplayResults(e);
}
function rShowMPResults(d){
 const e=[];Object.entries(d.players||{}).forEach(([id,p])=>{e.push({name:p.name,emoji:p.emoji,progress:p.progress||0,isPlayer:(id===R.myId),isAI:false,finishTime:p.finishTime||Infinity,finished:p.finished||p.progress>=100})});
 (d.settings.aiConfig||[]).forEach((a,i)=>{if(a.speed>0)e.push({name:a.name,emoji:a.emoji,progress:R.aiProgress[i]||0,isPlayer:false,isAI:true,finishTime:R.aiFinishTimes[i]||Infinity,finished:(R.aiProgress[i]||0)>=100})});
 e.sort((a,b)=>{if(a.finished&&b.finished)return a.finishTime-b.finishTime;if(a.finished&&!b.finished)return-1;if(!a.finished&&b.finished)return 1;return b.progress-a.progress});
 rDisplayResults(e);
}
function rDisplayResults(entries){
 showScreen('raceResultsScreen');
 const pct=R.totalQs>0?Math.round((R.correct/R.totalQs)*100):0;
 const pos=entries.findIndex(e=>e.isPlayer)+1;
 let trophy,title;
 if(pos===1){trophy='üèÜ';title='YOU WON!';confetti(40)}
 else if(pos===2){trophy='ü•à';title='2nd Place!';confetti(20)}
 else if(pos===3){trophy='ü•â';title='3rd Place!';confetti(10)}
 else{trophy='üéñÔ∏è';title='Good Effort!'}
 const pe=['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£'];
 let standingsHTML='';
 entries.forEach((e,i)=>{
  let st=Math.round(e.progress)+'%';
  if(e.finished&&R.raceStartTime){
   const s=Math.round((e.finishTime-R.raceStartTime)/1000);
   st='‚è± '+Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60);
  }
  standingsHTML+=`<div class="standing-row${e.isPlayer?' is-you':''}"><span class="standing-pos">${pe[i]||i+1}</span><span class="standing-emoji">${e.emoji}</span><span class="standing-name">${e.name}${e.isPlayer?' (YOU)':''}${e.isAI?' ü§ñ':''}</span><span class="standing-pct">${st}</span></div>`;
 });
 const m=Math.floor(R.timerSec/60),s=R.timerSec%60;
 let msg;if(pct===100&&pos===1)msg='PERFECT! ü•≥';else if(pos===1)msg='You won!';else if(pct>=70)msg='Great job!';else if(pct>=50)msg='Good effort!';else msg='Keep practicing!';
 let wrongHTML='';
 if(R.wrongList.length>0){
  wrongHTML='<div class="wrong-review"><h3>Review:</h3>';
  R.wrongList.forEach(w=>{wrongHTML+=`<div class="review-item"><span class="review-q">${w.q}</span><span>You: ${w.given}</span><span class="review-a">= ${w.correct}</span></div>`});
  wrongHTML+='</div>';
 }
 $('raceResultsCard').innerHTML=`<div class="results-trophy">${trophy}</div><h1 class="results-title">${title}</h1><p class="results-subtitle">Position ${pos} of ${entries.length}</p><div class="final-standings">${standingsHTML}</div><div class="results-stats"><div class="r-stat"><div class="r-stat-val">${R.correct}/${R.totalQs}</div><div class="r-stat-lbl">Correct</div></div><div class="r-stat"><div class="r-stat-val">${pct}%</div><div class="r-stat-lbl">Score</div></div><div class="r-stat"><div class="r-stat-val">${m}:${s<10?'0':''}${s}</div><div class="r-stat-lbl">Time</div></div></div><div class="results-msg">${msg}</div>${wrongHTML}<div class="btn-row"><button class="big-btn btn-red" onclick="rPlayAgain()">Again!</button><button class="secondary-btn" onclick="showHub()">Hub</button></div>`;
}
function rPlayAgain(){
 if(R.mode==='solo'){
  R.sharedQuestions=rGenAllQs();rInitGame();showScreen('raceGameScreen');
  runCountdown(()=>{rBuildTrack();rBegin()});
 }else{
  if(R.isHost&&R.roomRef){
   R.roomRef.update({state:'lobby',questions:rGenAllQs(),startTime:null}).catch(()=>{});
   Object.keys(R.roomData?.players||{}).forEach(id=>{
    R.roomRef.child('players/'+id).update({progress:0,correct:0,wrong:0,finished:false,finishTime:null,qIndex:0}).catch(()=>{});
   });
  }
  R.raceFinished=false;rBuildLobby();showScreen('raceLobbyScreen');
 }
}
window.addEventListener('beforeunload',()=>{if(R.roomRef&&R.myId&&db)try{R.roomRef.child('players/'+R.myId).remove()}catch(e){}});

// ================================================================
// GAME 2: MATH MARKET
// ================================================================
const SHOP_ITEMS=[
 {id:'apple',emoji:'üçé',name:'Apple',basePrice:2},
 {id:'banana',emoji:'üçå',name:'Banana',basePrice:1},
 {id:'milk',emoji:'ü•õ',name:'Milk',basePrice:3},
 {id:'bread',emoji:'üçû',name:'Bread',basePrice:4},
 {id:'egg',emoji:'ü•ö',name:'Egg',basePrice:1},
 {id:'cheese',emoji:'üßÄ',name:'Cheese',basePrice:5},
 {id:'juice',emoji:'üßÉ',name:'Juice',basePrice:3},
 {id:'cake',emoji:'üç∞',name:'Cake',basePrice:6},
 {id:'cookie',emoji:'üç™',name:'Cookie',basePrice:2},
 {id:'candy',emoji:'üç¨',name:'Candy',basePrice:1},
 {id:'pizza',emoji:'üçï',name:'Pizza',basePrice:8},
 {id:'icecream',emoji:'üç®',name:'Ice Cream',basePrice:4},
 {id:'toy',emoji:'üß∏',name:'Toy',basePrice:7},
 {id:'book',emoji:'üìò',name:'Book',basePrice:5},
 {id:'ball',emoji:'üèÄ',name:'Ball',basePrice:6},
 {id:'pencil',emoji:'‚úèÔ∏è',name:'Pencil',basePrice:1},
];
const CUSTOMERS=[
 {name:'Emma',emoji:'üëß'},{name:'Tom',emoji:'üë¶'},{name:'Grandma',emoji:'üëµ'},
 {name:'Dad',emoji:'üë®'},{name:'Mum',emoji:'üë©'},{name:'Mr Bear',emoji:'üêª'},
 {name:'Chef',emoji:'üë®‚Äçüç≥'},{name:'Teacher',emoji:'üë©‚Äçüè´'},
];
const MARKET_ACHIEVEMENTS=[
 {id:'first_sale',icon:'üí∞',title:'First Sale!',desc:'Complete your first transaction'},
 {id:'perfect_3',icon:'üéØ',title:'Sharpshooter!',desc:'3 correct answers in a row'},
 {id:'speed_demon',icon:'‚ö°',title:'Speed Demon!',desc:'Answer in under 3 seconds'},
 {id:'big_spender',icon:'üí∏',title:'Big Spender!',desc:'Handle a $50+ order'},
 {id:'level_up',icon:'‚¨ÜÔ∏è',title:'Level Up!',desc:'Reach a new level'},
 {id:'perfect_day',icon:'üåà',title:'Perfect Day!',desc:'Complete a day with 100% accuracy'},
 {id:'market_master',icon:'üèÜ',title:'Market Master!',desc:'Complete all 5 levels'},
];
let M={
 name:'',mode:'',level:1,xp:0,xpNeeded:100,
 day:0,totalDays:5,round:0,roundsPerDay:3,
 score:0,correct:0,wrong:0,streak:0,bestStreak:0,
 coins:0,totalEarned:0,
 cart:[],currentItems:[],currentCustomer:null,
 currentQ:null,answered:false,
 phase:'',
 achievements:[],newAchievements:[],
 timerSec:0,timerIntv:null,answerStartTime:0,
 wrongList:[],
 useCents:false,
 difficulty:'easy',
 cashierShowCosts:true,
 dayCorrect:0,dayWrong:0,
};
function mReset(){
 M={
  name:'',mode:'',level:1,xp:0,xpNeeded:100,
  day:0,totalDays:5,round:0,roundsPerDay:3,
  score:0,correct:0,wrong:0,streak:0,bestStreak:0,
  coins:0,totalEarned:0,
  cart:[],currentItems:[],currentCustomer:null,
  currentQ:null,answered:false,
  phase:'',
  achievements:JSON.parse(localStorage.getItem('marketAch')||'[]'),
  newAchievements:[],
  timerSec:0,timerIntv:null,answerStartTime:0,
  wrongList:[],
  useCents:M.useCents||false,
  difficulty:M.difficulty||'easy',
  cashierShowCosts:M.cashierShowCosts!==undefined?M.cashierShowCosts:true,
  dayCorrect:0,dayWrong:0,
 };
}
// Config UI
function mInitConfigUI(){
 const grid=$('cfgDiffGrid');
 if(grid){
  grid.innerHTML='';
  [{id:'easy',label:'Easy',cls:'opt-easy'},{id:'medium',label:'Medium',cls:'opt-medium'},{id:'hard',label:'Hard',cls:'opt-hard'}].forEach(d=>{
   const b=document.createElement('button');
   b.className='option-btn '+d.cls+(M.difficulty===d.id?' selected':'');
   b.textContent=d.label;
   b.style.minWidth='80px';b.style.fontSize='.8em';b.style.padding='6px 12px';
   b.onclick=()=>{grid.querySelectorAll('.option-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');M.difficulty=d.id};
   grid.appendChild(b);
  });
 }
 const ct=$('cfgCents');if(ct){if(M.useCents)ct.classList.add('active');else ct.classList.remove('active')}
 const cs=$('cfgCashierShow');if(cs){if(M.cashierShowCosts)cs.classList.add('active');else cs.classList.remove('active')}
}
function mToggleConfig(key){
 if(key==='cents'){
  M.useCents=!M.useCents;const el=$('cfgCents');if(el){if(M.useCents)el.classList.add('active');else el.classList.remove('active')}
 }else if(key==='cashierShow'){
  M.cashierShowCosts=!M.cashierShowCosts;const el=$('cfgCashierShow');if(el){if(M.cashierShowCosts)el.classList.add('active');else el.classList.remove('active')}
 }
}
// Difficulty-based helpers
function mGenPrice(basePrice){
 let diffMult=1;let levelAdd=Math.floor((M.level-1)*0.5);let dayAdd=Math.floor((M.day-1)*0.3);let streakAdd=Math.floor(M.streak*0.2);
 if(M.difficulty==='easy')diffMult=1;
 else if(M.difficulty==='medium'){diffMult=1.5;levelAdd=Math.floor((M.level-1)*1);dayAdd=Math.floor((M.day-1)*0.5)}
 else{diffMult=2;levelAdd=Math.floor((M.level-1)*1.5);dayAdd=Math.floor((M.day-1)*1)}
 let price=basePrice+levelAdd+dayAdd+streakAdd;price=Math.max(1,Math.round(price*diffMult));
 if(M.useCents){
  let centsOptions;
  if(M.difficulty==='easy')centsOptions=[0,0.25,0.50,0.75];
  else if(M.difficulty==='medium')centsOptions=[0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90];
  else centsOptions=[];
  if(M.difficulty==='hard'){price=price+Math.floor(Math.random()*99+1)/100}
  else{price=price+centsOptions[rand(0,centsOptions.length-1)]}
  price=mRound(price);
 }
 return price;
}
function mGetBudget(){if(M.difficulty==='easy')return M.useCents?25:25;if(M.difficulty==='medium')return M.useCents?40:40;return M.useCents?60:60}
function mGetItemCount(){let base=4;if(M.difficulty==='medium')base=5;if(M.difficulty==='hard')base=6;return Math.min(base+Math.floor(M.level/2)+Math.floor((M.day-1)/2),10)}
function mGetRoundsPerDay(){if(M.difficulty==='easy')return 3;if(M.difficulty==='medium')return 4;return 5}
function mGetNumCashierItems(){let base=1;if(M.difficulty==='easy')base=1+Math.floor(M.level/3);else if(M.difficulty==='medium')base=2+Math.floor(M.level/2);else base=2+Math.floor(M.level/2)+Math.floor((M.day-1)/2);return Math.min(base+Math.floor(M.streak*0.3),6)}
function mGetMaxQty(){if(M.difficulty==='easy')return Math.min(2+Math.floor(M.level/3),4);if(M.difficulty==='medium')return Math.min(3+Math.floor(M.level/2),6);return Math.min(3+Math.floor(M.level/2)+Math.floor(M.streak*0.3),8)}
// Start
function startMarketMode(mode){
 const name=$('marketName').value.trim();
 if(!name){toast('Enter your name first!','error');$('marketName').focus();return}
 mReset();M.name=name;M.mode=mode;M.day=1;M.round=0;
 const saved=localStorage.getItem('marketProgress_'+name);
 if(saved){const d=JSON.parse(saved);M.level=d.level||1;M.xp=d.xp||0;M.coins=d.coins||0;M.totalEarned=d.totalEarned||0}
 M.xpNeeded=M.level*100;
 M.roundsPerDay=mGetRoundsPerDay();
 mStartDay();
}
function mSaveProgress(){
 localStorage.setItem('marketProgress_'+M.name,JSON.stringify({level:M.level,xp:M.xp,coins:M.coins,totalEarned:M.totalEarned}));
 localStorage.setItem('marketAch',JSON.stringify(M.achievements));
}
function mStartDay(){M.round=0;M.answered=false;M.dayCorrect=0;M.dayWrong=0;M.roundsPerDay=mGetRoundsPerDay();mNextRound();}
function mNextRound(){
 M.round++;if(M.round>M.roundsPerDay){mEndDay();return}
 M.cart=[];M.answered=false;M.answerStartTime=Date.now();
 if(M.mode==='shopper')mBuildShopperRound();
 else if(M.mode==='cashier')mBuildCashierRound();
 else if(M.mode==='owner')mBuildOwnerRound();
}
function mBuildShopperRound(){
 const itemCount=mGetItemCount();M.currentItems=[];
 const shuffled=[...SHOP_ITEMS].sort(()=>Math.random()-0.5);
 for(let i=0;i<Math.min(itemCount,shuffled.length);i++){const item={...shuffled[i]};item.price=mGenPrice(item.basePrice);M.currentItems.push(item);}
 const budget=mGetBudget();M.phase='shopping';
 showScreen('marketGameScreen');
 $('marketGameScreen').innerHTML=`
 <div class="shop-header">
  <div class="shop-name">${M.name}'s Shopping Trip</div>
  <div class="shop-stats">
   <div class="shop-stat"><span class="coin-icon">ü™ô</span> $${M.coins}</div>
   <div class="shop-stat">Lv${M.level}</div>
   <div class="shop-stat">Day ${M.day}/${M.totalDays}</div>
   <button class="home-btn" onclick="mGoHome()">Home</button>
  </div>
 </div>
 <div class="xp-bar-container"><div class="xp-bar" style="width:${(M.xp/M.xpNeeded)*100}%"></div></div>
 <p class="xp-text">XP: ${M.xp}/${M.xpNeeded}</p>
 <div class="day-progress" id="mDayProg"></div>
 <div class="shop-shelf">
  <div class="shelf-title">Shop Shelf ‚Äî Pick items for your basket! (Budget: ${mFmtPrice(budget)})</div>
  <div class="shelf-items" id="mShelf"></div>
 </div>
 <div id="mBudgetWarning"></div>
 <div class="cart-panel">
  <div class="cart-title"><span>Your Cart</span><span id="mCartCount">0 items</span></div>
  <div class="cart-items" id="mCartItems"><div class="cart-empty">Tap items above to add them!</div></div>
 </div>
 <div style="text-align:center">
  <button class="big-btn btn-green" id="mCheckoutBtn" onclick="mGoCheckout()" disabled>Checkout</button>
 </div>`;
 mBuildDayDots();mRenderShelf();
}
function mGoHome(){
 if(confirm('Are you sure you want to go back to the home screen? Your current round progress will be lost.')){
  showScreen('marketHomeScreen');mInitConfigUI();
 }
}
function mRenderShelf(){
 const shelf=$('mShelf');shelf.innerHTML='';const budget=mGetBudget();
 const cartTotal=M.cart.reduce((s,c)=>s+mRound(c.price*c.qty),0);
 M.currentItems.forEach(item=>{
  const d=document.createElement('div');d.className='shop-item';
  const inCart=M.cart.find(c=>c.id===item.id);if(inCart)d.classList.add('in-cart');
  const wouldCost=cartTotal+item.price;const overBudget=wouldCost>budget&&!inCart;
  if(overBudget)d.classList.add('disabled-item');
  d.innerHTML=`<span class="item-emoji">${item.emoji}</span><span class="item-name">${item.name}</span><span class="item-price">${mFmtPrice(item.price)} each</span>`;
  d.onclick=()=>{if(overBudget){toast('Over budget! Remove items or pick cheaper ones.','error');return}mAddToCart(item)};
  shelf.appendChild(d);
 });
}
function mAddToCart(item){
 const budget=mGetBudget();const cartTotal=M.cart.reduce((s,c)=>s+mRound(c.price*c.qty),0);
 if(mRound(cartTotal+item.price)>budget){toast('Over budget! You can\'t add more items.','error');return}
 const existing=M.cart.find(c=>c.id===item.id);
 if(existing){
  if(mRound(cartTotal+item.price)>budget){toast('Over budget!','error');return}
  existing.qty++;
 }else M.cart.push({...item,qty:1});
 mRenderCart();mRenderShelf();mUpdateBudgetWarning();
}
function mUpdateBudgetWarning(){
 const budget=mGetBudget();const cartTotal=mRound(M.cart.reduce((s,c)=>s+mRound(c.price*c.qty),0));
 const warn=$('mBudgetWarning');if(!warn)return;const remaining=mRound(budget-cartTotal);
 if(M.cart.length===0){warn.innerHTML='';return}
 if(remaining<0){
  warn.innerHTML=`<div class="budget-warning">Over budget by <span class="budget-over">${mFmtPrice(Math.abs(remaining))}</span>! Remove items.</div>`;
 }else if(remaining<=budget*0.2){
  warn.innerHTML=`<div class="budget-warning" style="background:#e8f5e9;border-color:#4caf50;color:#2e7d32">Budget remaining: <span class="budget-ok">${mFmtPrice(remaining)}</span></div>`;
 }else{
  warn.innerHTML=`<div style="text-align:center;font-size:.85em;color:#888;margin:4px 0">Budget remaining: ${mFmtPrice(remaining)}</div>`;
 }
}
function mRenderCart(){
 const ci=$('mCartItems');const cc=$('mCartCount');const cb=$('mCheckoutBtn');
 if(M.cart.length===0){
  ci.innerHTML='<div class="cart-empty">Tap items above to add them!</div>';cc.textContent='0 items';cb.disabled=true;mUpdateBudgetWarning();return;
 }
 ci.innerHTML='';let total=0;
 M.cart.forEach((item,idx)=>{
  const subtotal=mRound(item.price*item.qty);total+=subtotal;
  const row=document.createElement('div');row.className='cart-row';
  row.innerHTML=`<div class="cart-row-left"><span>${item.emoji}</span><span>${item.name}</span></div><div class="cart-qty"><button class="qty-btn" onclick="mChangeQty(${idx},-1)">‚àí</button><span class="qty-num">${item.qty}</span><button class="qty-btn" onclick="mChangeQty(${idx},1)">+</button></div>`;
  ci.appendChild(row);
 });
 cc.textContent=M.cart.reduce((s,c)=>s+c.qty,0)+' items';cb.disabled=false;mUpdateBudgetWarning();
}
function mChangeQty(idx,delta){
 if(delta>0){
  const budget=mGetBudget();
  const cartTotal=mRound(M.cart.reduce((s,c)=>s+mRound(c.price*c.qty),0));
  if(mRound(cartTotal+M.cart[idx].price)>budget){toast('Over budget!','error');return}
 }
 M.cart[idx].qty+=delta;if(M.cart[idx].qty<=0)M.cart.splice(idx,1);
 mRenderCart();mRenderShelf();
}
function mGoCheckout(){
 M.phase='checkout';M.answerStartTime=Date.now();
 const total=mRound(M.cart.reduce((s,c)=>s+mRound(c.price*c.qty),0));
 let breakdownHTML='';M.cart.forEach(c=>{breakdownHTML+=`<div class="breakdown-row"><span>${c.emoji} ${c.name} √ó ${c.qty}</span><span>${mFmtPrice(c.price)} each</span></div>`});
 breakdownHTML+=`<div class="breakdown-row"><span>TOTAL</span><span>= ?</span></div>`;
 M.currentQ={type:'total',answer:total,cart:[...M.cart]};
 $('marketGameScreen').innerHTML=`
 <div class="shop-header"><div class="shop-name">Checkout</div><div class="shop-stats"><div class="shop-stat">Day ${M.day} ‚Ä¢ Round ${M.round}/${M.roundsPerDay}</div><button class="home-btn" onclick="mGoHome()">Home</button></div></div>
 <div class="checkout-card">
  <span class="level-badge level-${Math.min(M.level,5)}">Level ${M.level} ‚Ä¢ ${M.difficulty.charAt(0).toUpperCase()+M.difficulty.slice(1)}</span>
  <div class="customer-bubble"><div class="customer-header"><span class="customer-avatar">üßç</span><span class="customer-name">Your Shopping</span></div></div>
  <div class="checkout-breakdown">${breakdownHTML}</div>
  <div class="checkout-q">What is the total cost?</div>
  <div class="checkout-hint">${mGetCalcHint()}</div>
  <div class="answer-row"><input type="${M.useCents?'text':'number'}" id="mAns" class="answer-input" placeholder="${M.useCents?'$0.00':'$?'}" autocomplete="off" inputmode="decimal"><button class="submit-btn" onclick="mCheckAnswer()">Pay!</button></div>
  <div class="feedback-area" id="mFB"></div>
  <div class="hint-box" id="mHint"></div>
 </div>`;
 $('mAns').addEventListener('keydown',e=>{if(e.key==='Enter')mCheckAnswer()});
 if(M.useCents)$('mAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9.]/g,'')});
 else $('mAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9]/g,'')});
 setTimeout(()=>$('mAns').focus(),200);
}
function mGetCalcHint(){if(M.cart.length<=2)return 'Add up the prices!';if(M.useCents)return 'Tip: Add dollars first, then cents!';return 'Tip: Add the prices one by one!';}
function mBuildCashierRound(){
 const cust=CUSTOMERS[rand(0,CUSTOMERS.length-1)];M.currentCustomer=cust;
 const numItems=mGetNumCashierItems();const items=[];const shuffled=[...SHOP_ITEMS].sort(()=>Math.random()-0.5);
 for(let i=0;i<Math.min(numItems,shuffled.length);i++){
  const item={...shuffled[i]};item.price=mGenPrice(item.basePrice);item.qty=rand(1,mGetMaxQty());items.push(item);
 }
 M.cart=items;
 const total=mRound(items.reduce((s,c)=>s+mRound(c.price*c.qty),0));
 let payWith;
 if(M.useCents){payWith=Math.ceil(total/5)*5+rand(1,3)*5;}
 else{payWith=Math.ceil(total/10)*10+rand(0,2)*10;if(payWith===total)payWith+=10;}
 const change=mRound(payWith-total);
 M.currentQ={type:'change',total:total,paid:payWith,answer:change,items:items};
 M.phase='checkout';M.answerStartTime=Date.now();
 let orderHTML='';
 items.forEach(c=>{
  if(M.cashierShowCosts)orderHTML+=`<div class="breakdown-row"><span>${c.emoji} ${c.name} √ó ${c.qty}</span><span>${mFmtPrice(mRound(c.price*c.qty))}</span></div>`;
  else orderHTML+=`<div class="breakdown-row"><span>${c.emoji} ${c.name} √ó ${c.qty}</span><span>${mFmtPrice(c.price)} each</span></div>`;
 });
 orderHTML+=`<div class="breakdown-row"><span>TOTAL</span><span>= ?</span></div>`;
 showScreen('marketGameScreen');
 $('marketGameScreen').innerHTML=`
 <div class="shop-header"><div class="shop-name">Cashier Desk</div><div class="shop-stats"><div class="shop-stat"><span class="coin-icon">ü™ô</span> $${M.coins}</div><div class="shop-stat">Lv${M.level}</div><div class="shop-stat">Day ${M.day}</div><button class="home-btn" onclick="mGoHome()">Home</button></div></div>
 <div class="xp-bar-container"><div class="xp-bar" style="width:${(M.xp/M.xpNeeded)*100}%"></div></div>
 <div class="day-progress" id="mDayProg"></div>
 <div class="checkout-card">
  <span class="level-badge level-${Math.min(M.level,5)}">Level ${M.level} ‚Ä¢ ${M.difficulty.charAt(0).toUpperCase()+M.difficulty.slice(1)}</span>
  <div class="customer-bubble"><div class="customer-header"><span class="customer-avatar">${cust.emoji}</span><span class="customer-name">${cust.name}</span></div><div class="customer-order">"Here are my items!"</div></div>
  <div class="checkout-breakdown">${orderHTML}</div>
  <div class="checkout-q">${cust.name} pays with ${mFmtPrice(payWith)}. How much change?</div>
  <div class="answer-row"><input type="${M.useCents?'text':'number'}" id="mAns" class="answer-input" placeholder="${M.useCents?'$0.00':'$?'}" autocomplete="off" inputmode="decimal"><button class="submit-btn" onclick="mCheckAnswer()">Give Change!</button></div>
  <div class="feedback-area" id="mFB"></div>
  <div class="hint-box" id="mHint"></div>
 </div>`;
 mBuildDayDots();
 $('mAns').addEventListener('keydown',e=>{if(e.key==='Enter')mCheckAnswer()});
 if(M.useCents)$('mAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9.]/g,'')});
 else $('mAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9]/g,'')});
 setTimeout(()=>$('mAns').focus(),200);
}
function mBuildOwnerRound(){
 const scenarios=[];const scaleFactor=(M.difficulty==='easy'?1:M.difficulty==='medium'?1.5:2)+(M.level-1)*0.3+(M.day-1)*0.2+M.streak*0.1;
 scenarios.push(()=>{const item=SHOP_ITEMS[rand(0,SHOP_ITEMS.length-1)];const qty=rand(3,Math.floor(5+scaleFactor*2));const price=mGenPrice(item.basePrice);const answer=mRound(qty*price);return{q:`You sold ${qty} ${item.emoji} ${item.name}s at ${mFmtPrice(price)} each. How much did you earn?`,answer,hint:`${qty} √ó ${mFmtPrice(price)} = ?`,type:'earn'};});
 scenarios.push(()=>{const item=SHOP_ITEMS[rand(0,SHOP_ITEMS.length-1)];const total=rand(Math.floor(10+scaleFactor*3),Math.floor(20+scaleFactor*5));const perBox=rand(3,Math.floor(4+scaleFactor));const boxes=Math.ceil(total/perBox);return{q:`You need ${total} ${item.emoji} ${item.name}s. They come in boxes of ${perBox}. How many boxes do you need?`,answer:boxes,hint:`${total} √∑ ${perBox} = ? (round up!)`,type:'stock'};});
 scenarios.push(()=>{const items=[];let totalCost=0;const numItems=rand(2,Math.min(2+Math.floor(scaleFactor),4));for(let i=0;i<numItems;i++){const it=SHOP_ITEMS[rand(0,SHOP_ITEMS.length-1)];const qty=rand(2,Math.floor(3+scaleFactor));const price=mGenPrice(it.basePrice);const cost=mRound(price*qty);items.push({...it,qty,cost,price});totalCost=mRound(totalCost+cost);}return{q:`Today's stock costs: ${items.map(i=>`${i.qty}√ó${i.emoji}=${mFmtPrice(i.cost)}`).join(', ')}. Total stock cost?`,answer:totalCost,hint:'Add up all the costs!',type:'cost'};});
 scenarios.push(()=>{const earn=rand(Math.floor(20+scaleFactor*5),Math.floor(50+scaleFactor*10));const spend=rand(Math.floor(10+scaleFactor*2),earn-5);return{q:`Today you earned ${mFmtPrice(earn)} but spent ${mFmtPrice(spend)} on supplies. What's your profit?`,answer:mRound(earn-spend),hint:`${mFmtPrice(earn)} ‚àí ${mFmtPrice(spend)} = ?`,type:'profit'};});
 const scenario=scenarios[rand(0,scenarios.length-1)]();M.currentQ={type:scenario.type,answer:scenario.answer};
 M.phase='checkout';M.answerStartTime=Date.now();showScreen('marketGameScreen');
 $('marketGameScreen').innerHTML=`
 <div class="shop-header"><div class="shop-name">Shop Owner</div><div class="shop-stats"><div class="shop-stat"><span class="coin-icon">ü™ô</span> $${M.coins}</div><div class="shop-stat">Lv${M.level}</div><div class="shop-stat">Day ${M.day}</div><button class="home-btn" onclick="mGoHome()">Home</button></div></div>
 <div class="xp-bar-container"><div class="xp-bar" style="width:${(M.xp/M.xpNeeded)*100}%"></div></div>
 <div class="day-progress" id="mDayProg"></div>
 <div class="checkout-card">
  <span class="level-badge level-${Math.min(M.level,5)}">Level ${M.level} ‚Ä¢ ${M.difficulty.charAt(0).toUpperCase()+M.difficulty.slice(1)}</span>
  <div class="customer-bubble"><div class="customer-header"><span class="customer-avatar">üìã</span><span class="customer-name">Daily Task</span></div><div class="customer-order">${scenario.q}</div></div>
  <div class="checkout-q">What's the answer?</div>
  <div class="answer-row"><input type="${M.useCents?'text':'number'}" id="mAns" class="answer-input" placeholder="${M.useCents?'$0.00':'?'}" autocomplete="off" inputmode="decimal"><button class="submit-btn" onclick="mCheckAnswer()">Submit!</button></div>
  <div class="feedback-area" id="mFB"></div>
  <div class="hint-box" id="mHint">${scenario.hint?'<strong>Hint:</strong> '+scenario.hint:''}</div>
 </div>`;
 mBuildDayDots();if(M.currentQ.answer>20||M.difficulty!=='easy')$('mHint').style.display='block';
 $('mAns').addEventListener('keydown',e=>{if(e.key==='Enter')mCheckAnswer()});
 if(M.useCents)$('mAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9.]/g,'')});
 else $('mAns').addEventListener('input',function(){this.value=this.value.replace(/[^0-9]/g,'')});
 setTimeout(()=>$('mAns').focus(),200);
}
function mBuildDayDots(){
 const dp=$('mDayProg');if(!dp)return;dp.innerHTML='';
 for(let i=1;i<=M.roundsPerDay;i++){
  const dot=document.createElement('div');dot.className='day-dot';
  if(i<M.round)dot.classList.add('complete');
  else if(i===M.round)dot.classList.add('current');
  else dot.classList.add('locked');
  dot.textContent=i;dp.appendChild(dot);
 }
}
function mCheckAnswer(){
 if(M.answered)return;
 const inp=$('mAns');if(!inp)return;
 const val=inp.value.trim();if(val===''){inp.className='answer-input wrong-flash';setTimeout(()=>inp.className='answer-input',500);return}
 let ua;
 if(M.useCents){ua=parseFloat(val);if(isNaN(ua)){inp.className='answer-input wrong-flash';setTimeout(()=>inp.className='answer-input',500);return}ua=mRound(ua);}
 else{ua=parseInt(val);if(isNaN(ua)){inp.className='answer-input wrong-flash';setTimeout(()=>inp.className='answer-input',500);return}}
 const q=M.currentQ;const correctAnswer=M.useCents?mRound(q.answer):Math.round(q.answer);
 M.answered=true;inp.disabled=true;const timeTaken=(Date.now()-M.answerStartTime)/1000;
 if(ua===correctAnswer){
  M.correct++;M.dayCorrect++;M.streak++;if(M.streak>M.bestStreak)M.bestStreak=M.streak;
  inp.className='answer-input correct-flash';
  const bonus=timeTaken<5?3:timeTaken<10?2:1;
  const diffBonus=M.difficulty==='easy'?1:M.difficulty==='medium'?1.5:2;
  const xpGain=Math.round(10*bonus*diffBonus);const coinGain=Math.round(5*bonus*diffBonus);
  M.xp+=xpGain;M.coins+=coinGain;M.totalEarned+=coinGain;M.score+=bonus*10;
  $('mFB').innerHTML=`<span class="fb-emoji">üéâ</span><span class="fb-correct">Correct! +${xpGain} XP, +$${coinGain}${bonus>1?' (Speed Bonus!)':''}</span>`;
  confetti(5);floatTxt('+$'+coinGain,'#fdcb6e');
  if(M.correct===1)mUnlockAch('first_sale');
  if(M.streak>=3)mUnlockAch('perfect_3');
  if(timeTaken<3)mUnlockAch('speed_demon');
  if(correctAnswer>=50)mUnlockAch('big_spender');
  if(M.xp>=M.xpNeeded){M.level++;M.xp-=M.xpNeeded;M.xpNeeded=M.level*100;mUnlockAch('level_up');if(M.level>=6)mUnlockAch('market_master')}
 }else{
  M.wrong++;M.dayWrong++;M.streak=0;
  inp.className='answer-input wrong-flash';
  const dir=ua<correctAnswer?'bigger':'smaller';
  $('mFB').innerHTML=`<span class="fb-emoji">üòÖ</span><span class="fb-wrong">Not quite! Answer: <strong>${mFmtPrice(correctAnswer)}</strong> (yours was too ${dir})</span>`;
  M.wrongList.push({q:M.mode+' round (Day '+M.day+')',correct:correctAnswer,given:ua});
  const hint=$('mHint');if(hint){hint.style.display='block';if(!hint.innerHTML)hint.innerHTML='<strong>Hint:</strong> The correct answer is '+mFmtPrice(correctAnswer);}
 }
 mSaveProgress();
 setTimeout(()=>{M.answered=false;mNextRound()},ua===correctAnswer?1500:2800);
}
function mEndDay(){
 M.day++;if(M.dayWrong===0&&M.dayCorrect>0)mUnlockAch('perfect_day');
 if(M.day>M.totalDays){mShowResults();return}
 showScreen('marketGameScreen');
 $('marketGameScreen').innerHTML=`<div class="card">
  <span style="font-size:3em;display:block;margin-bottom:10px">üìÖ</span>
  <h2 style="color:var(--green)">Day ${M.day-1} Complete!</h2>
  <p style="color:#888;margin:10px 0">Great work, ${M.name}!</p>
  <div class="shop-results-stats">
   <div class="r-stat"><div class="r-stat-val">${M.dayCorrect}/${M.dayCorrect+M.dayWrong}</div><div class="r-stat-lbl">Today's Score</div></div>
   <div class="r-stat"><div class="r-stat-val">$${M.coins}</div><div class="r-stat-lbl">Total Coins</div></div>
   <div class="r-stat"><div class="r-stat-val">Lv${M.level}</div><div class="r-stat-lbl">Level</div></div>
   <div class="r-stat"><div class="r-stat-val">üî• ${M.streak}</div><div class="r-stat-lbl">Streak</div></div>
  </div>
  <div class="xp-bar-container"><div class="xp-bar" style="width:${(M.xp/M.xpNeeded)*100}%"></div></div>
  <p class="xp-text">XP: ${M.xp}/${M.xpNeeded} to Level ${M.level+1}</p>
  <button class="big-btn btn-green" onclick="mStartDay()">Next Day!</button>
  <br><button class="home-btn" style="margin-top:10px" onclick="mGoHome()">Back to Home</button>
 </div>`;
}
function mShowResults(){
 clearInterval(M.timerIntv);
 const pct=M.correct+M.wrong>0?Math.round(M.correct/(M.correct+M.wrong)*100):0;
 let trophy,title;
 if(pct>=90){trophy='üèÜ';title='Market Master!';confetti(40)}
 else if(pct>=70){trophy='ü•á';title='Great Trader!';confetti(20)}
 else if(pct>=50){trophy='ü•à';title='Good Worker!';confetti(10)}
 else{trophy='üéñÔ∏è';title='Keep Practicing!'}
 let wrongHTML='';
 if(M.wrongList.length>0){
  wrongHTML='<div class="wrong-review"><h3>Review:</h3>';
  M.wrongList.forEach(w=>{wrongHTML+=`<div class="review-item"><span class="review-q">${w.q}</span><span>You: ${M.useCents?'$'+w.given.toFixed(2):w.given}</span><span class="review-a">= ${M.useCents?'$'+w.correct.toFixed(2):'$'+w.correct}</span></div>`});
  wrongHTML+='</div>';
 }
 let achHTML='';
 if(M.newAchievements.length>0){
  achHTML='<div style="margin:10px 0"><h3 style="color:var(--orange);text-align:center;margin-bottom:8px">Achievements Earned!</h3>';
  M.newAchievements.forEach(a=>{achHTML+=`<div style="background:#fff9e6;border-radius:10px;padding:8px 12px;margin-bottom:4px;display:flex;align-items:center;gap:8px;font-size:.9em"><span style="font-size:1.5em">${a.icon}</span><div><strong>${a.title}</strong><br><span style="color:#888;font-size:.85em">${a.desc}</span></div></div>`});
  achHTML+='</div>';
 }
 showScreen('marketResultsScreen');
 $('marketResultsCard').innerHTML=`
 <div class="results-trophy">${trophy}</div>
 <h1 class="results-title">${title}</h1>
 <p class="results-subtitle">${M.name}'s ${M.totalDays}-Day Market Report (${M.difficulty.charAt(0).toUpperCase()+M.difficulty.slice(1)}${M.useCents?' + Cents':''})</p>
 <div class="results-stats">
  <div class="r-stat"><div class="r-stat-val">${M.correct}</div><div class="r-stat-lbl">Correct</div></div>
  <div class="r-stat"><div class="r-stat-val">${pct}%</div><div class="r-stat-lbl">Accuracy</div></div>
  <div class="r-stat"><div class="r-stat-val">$${M.totalEarned}</div><div class="r-stat-lbl">Earned</div></div>
  <div class="r-stat"><div class="r-stat-val">Lv${M.level}</div><div class="r-stat-lbl">Level</div></div>
  <div class="r-stat"><div class="r-stat-val">${M.bestStreak}</div><div class="r-stat-lbl">Streak</div></div>
  <div class="r-stat"><div class="r-stat-val">${M.wrong}</div><div class="r-stat-lbl">Mistakes</div></div>
 </div>
 ${achHTML}
 <div class="results-msg">${pct>=70?'Amazing work! Your math skills are growing!':'Keep practicing ‚Äî every day you get better!'}</div>
 ${wrongHTML}
 <div class="btn-row">
  <button class="big-btn btn-green" onclick="mPlayAgain()">Play Again!</button>
  <button class="secondary-btn" onclick="showHub()">Hub</button>
 </div>`;
}
function mPlayAgain(){mInitConfigUI();showScreen('marketHomeScreen')}
function mUnlockAch(id){
 if(M.achievements.includes(id))return;
 const ach=MARKET_ACHIEVEMENTS.find(a=>a.id===id);if(!ach)return;
 M.achievements.push(id);M.newAchievements.push(ach);mSaveProgress();
 const popup=document.createElement('div');popup.className='achievement-popup';
 popup.innerHTML=`<span class="ach-icon">${ach.icon}</span><div class="ach-title">${ach.title}</div><div class="ach-desc">${ach.desc}</div><button class="ach-close" onclick="this.parentElement.remove()">Nice!</button>`;
 document.body.appendChild(popup);confetti(8);
 setTimeout(()=>{if(popup.parentElement)popup.remove()},4000);
}

// ================================================================
// GAME 3: SPELLING BEE (Expanded with 6 New Categories)
// ================================================================

const wordDatabase={
 animals:{emoji:'üêæ',label:'Animals',easy:[
  { word:'cat',emoji:'üê±',hint:'A pet that says meow',sentence:'The ___ sat on the mat.' },
  { word:'dog',emoji:'üê∂',hint:'A pet that says woof',sentence:'The ___ likes to play fetch.' },
  { word:'pig',emoji:'üê∑',hint:'A pink farm animal',sentence:'The ___ rolls in mud.' },
  { word:'hen',emoji:'üêî',hint:'A farm bird that lays eggs',sentence:'The ___ laid an egg.' },
  { word:'cow',emoji:'üêÆ',hint:'It gives us milk',sentence:'The ___ says moo.' },
  { word:'fox',emoji:'ü¶ä',hint:'A clever orange animal',sentence:'The ___ is very clever.' },
  { word:'bat',emoji:'ü¶á',hint:'It flies at night',sentence:'The ___ comes out at night.' },
  { word:'ant',emoji:'üêú',hint:'A tiny insect that is very strong',sentence:'The ___ carried a crumb.' },
  { word:'bee',emoji:'üêù',hint:'It makes honey and buzzes',sentence:'The ___ makes honey.' },
  { word:'owl',emoji:'ü¶â',hint:'A wise bird that says hoot',sentence:'The ___ hoots at night.' },
  { word:'ram',emoji:'üêè',hint:'A male sheep with big horns',sentence:'The ___ has big horns.' },
  { word:'yak',emoji:'üêÇ',hint:'A big hairy animal from the mountains',sentence:'The ___ has long fur.' },
 ],medium:[
  { word:'fish',emoji:'üêü',hint:'It swims in water',sentence:'The ___ swims in the sea.' },
  { word:'bird',emoji:'üê¶',hint:'It has wings and can fly',sentence:'The ___ sings a song.' },
  { word:'duck',emoji:'ü¶Ü',hint:'It says quack quack',sentence:'The ___ swims in the pond.' },
  { word:'frog',emoji:'üê∏',hint:'It jumps and says ribbit',sentence:'The ___ jumped into the pond.' },
  { word:'bear',emoji:'üêª',hint:'A big furry animal that loves honey',sentence:'The ___ sleeps in winter.' },
  { word:'deer',emoji:'ü¶å',hint:'It has antlers on its head',sentence:'The ___ ran through the forest.' },
  { word:'lion',emoji:'ü¶Å',hint:'The king of the jungle',sentence:'The ___ has a big mane.' },
  { word:'goat',emoji:'üêê',hint:'A farm animal that climbs mountains',sentence:'The ___ climbed the hill.' },
  { word:'wolf',emoji:'üê∫',hint:'It howls at the moon',sentence:'The ___ howled at the moon.' },
  { word:'crab',emoji:'ü¶Ä',hint:'It has claws and walks sideways',sentence:'The ___ walked on the beach.' },
  { word:'lamb',emoji:'üêë',hint:'A baby sheep',sentence:'The little ___ followed Mary.' },
  { word:'pony',emoji:'üê¥',hint:'A small horse',sentence:'She rode the ___ at the farm.' },
 ],hard:[
  { word:'rabbit',emoji:'üê∞',hint:'It has long ears and hops',sentence:'The ___ hopped through the garden.' },
  { word:'monkey',emoji:'üêµ',hint:'It loves bananas and climbs trees',sentence:'The ___ swung from tree to tree.' },
  { word:'turtle',emoji:'üê¢',hint:'It carries its house on its back',sentence:'The ___ moved very slowly.' },
  { word:'parrot',emoji:'ü¶ú',hint:'A colourful bird that can talk',sentence:'The ___ repeated my words.' },
  { word:'kitten',emoji:'üê±',hint:'A baby cat',sentence:'The ___ played with yarn.' },
  { word:'spider',emoji:'üï∑Ô∏è',hint:'It makes webs to catch flies',sentence:'The ___ spun a beautiful web.' },
  { word:'donkey',emoji:'üê¥',hint:'It looks like a small horse and says hee-haw',sentence:'The ___ carried the heavy bags.' },
  { word:'dragon',emoji:'üêâ',hint:'A magical creature that breathes fire',sentence:'The ___ flew over the castle.' },
  { word:'penguin',emoji:'üêß',hint:'A bird that cannot fly but swims very well',sentence:'The ___ waddled on the ice.' },
  { word:'dolphin',emoji:'üê¨',hint:'A smart sea animal that jumps out of water',sentence:'The ___ jumped through the hoop.' },
  { word:'giraffe',emoji:'ü¶í',hint:'The tallest animal with a very long neck',sentence:'The ___ ate leaves from the tall tree.' },
  { word:'elephant',emoji:'üêò',hint:'The biggest land animal with a long trunk',sentence:'The ___ sprayed water with its trunk.' },
 ]},
 food: {emoji: 'üçî',label: 'Food',easy: [{ word: 'egg', emoji: 'ü•ö', hint: 'Hens lay this', sentence: 'I had an ___ for breakfast.' },{ word: 'jam', emoji: 'üçì', hint: 'Sweet spread for toast', sentence: 'I put ___ on my bread.' },{ word: 'pie', emoji: 'ü•ß', hint: 'A baked food with filling inside', sentence: 'Mum made an apple ___.' },{ word: 'nut', emoji: 'ü•ú', hint: 'Squirrels love to eat these', sentence: 'The squirrel ate a ___.' },{ word: 'pea', emoji: 'üü¢', hint: 'A small round green vegetable', sentence: 'I ate a ___ from my plate.' },{ word: 'ham', emoji: 'üçñ', hint: 'Meat from a pig', sentence: 'We had ___ sandwiches for lunch.' },{ word: 'bun', emoji: 'üçû', hint: 'A small round bread', sentence: 'I ate a ___ with butter.' },{ word: 'fig', emoji: 'üçá', hint: 'A sweet purple fruit', sentence: 'The ___ was sweet and soft.' },{ word: 'yam', emoji: 'üç†', hint: 'An orange root vegetable', sentence: 'We baked a ___ for dinner.' },{ word: 'cup', emoji: '‚òï', hint: 'You drink from this', sentence: 'I drank milk from a ___.' },],medium: [{ word: 'cake', emoji: 'üéÇ', hint: 'A sweet treat for birthdays', sentence: 'We had ___ at the party.' },{ word: 'rice', emoji: 'üçö', hint: 'Small white grains we cook', sentence: 'We had ___ for dinner.' },{ word: 'corn', emoji: 'üåΩ', hint: 'A yellow vegetable on a cob', sentence: 'I love eating ___ on the cob.' },{ word: 'milk', emoji: 'ü•õ', hint: 'A white drink from cows', sentence: 'I drink ___ every morning.' },{ word: 'plum', emoji: 'üçë', hint: 'A small purple fruit', sentence: 'The ___ was juicy and sweet.' },{ word: 'soup', emoji: 'üç≤', hint: 'A hot liquid food you eat with a spoon', sentence: 'Mum made chicken ___.' },{ word: 'taco', emoji: 'üåÆ', hint: 'A folded shell with filling inside', sentence: 'I ate a ___ for lunch.' },{ word: 'bean', emoji: 'ü´ò', hint: 'A small seed we can cook and eat', sentence: 'I like ___ on toast.' },{ word: 'pear', emoji: 'üçê', hint: 'A green fruit shaped like a bell', sentence: 'The ___ was ripe and sweet.' },{ word: 'lime', emoji: 'üçã', hint: 'A small sour green fruit', sentence: 'I squeezed ___ juice on my food.' },],hard: [{ word: 'apple', emoji: 'üçé', hint: 'A red or green crunchy fruit', sentence: 'I packed an ___ in my lunchbox.' },{ word: 'bread', emoji: 'üçû', hint: 'We make sandwiches with this', sentence: 'I spread butter on the ___.' },{ word: 'pizza', emoji: 'üçï', hint: 'Round food with cheese and toppings', sentence: 'We ordered ___ for dinner.' },{ word: 'grape', emoji: 'üçá', hint: 'Small round fruits that grow in bunches', sentence: 'I ate a bunch of ___s.' },{ word: 'mango', emoji: 'ü•≠', hint: 'A sweet tropical orange fruit', sentence: 'The ___ was ripe and juicy.' },{ word: 'lemon', emoji: 'üçã', hint: 'A sour yellow fruit', sentence: 'The ___ was very sour.' },{ word: 'onion', emoji: 'üßÖ', hint: 'It makes you cry when you cut it', sentence: 'Chopping the ___ made me cry.' },{ word: 'pasta', emoji: 'üçù', hint: 'Italian food made from dough', sentence: 'We had ___ with tomato sauce.' },{ word: 'cheese', emoji: 'üßÄ', hint: 'A yellow food made from milk', sentence: 'I put ___ on my sandwich.' },{ word: 'banana', emoji: 'üçå', hint: 'A long yellow fruit monkeys love', sentence: 'The monkey ate a ___.' },{ word: 'carrot', emoji: 'ü•ï', hint: 'An orange vegetable rabbits love', sentence: 'The rabbit ate a ___.' },{ word: 'cherry', emoji: 'üçí', hint: 'Small red fruits that grow in pairs', sentence: 'I put a ___ on top of the cake.' },]},
 nature: {emoji: 'üåà',label: 'Nature',easy: [{ word: 'sun', emoji: '‚òÄÔ∏è', hint: 'It shines bright in the sky during the day', sentence: 'The ___ is shining today.' },{ word: 'sea', emoji: 'üåä', hint: 'A big body of salt water', sentence: 'We swam in the ___.' },{ word: 'sky', emoji: '‚òÅÔ∏è', hint: 'Look up and you see this', sentence: 'The ___ is blue today.' },{ word: 'mud', emoji: 'üü§', hint: 'Wet dirt that is squishy', sentence: 'The pig played in the ___.' },{ word: 'log', emoji: 'ü™µ', hint: 'A piece of a tree trunk', sentence: 'We sat on a ___.' },{ word: 'dew', emoji: 'üíß', hint: 'Water drops on grass in the morning', sentence: 'The ___ sparkled in the morning.' },{ word: 'ice', emoji: 'üßä', hint: 'Frozen water', sentence: 'The pond turned to ___.' },{ word: 'bay', emoji: 'üèñÔ∏è', hint: 'A curved part of the coast', sentence: 'We sailed into the ___.' },],medium: [{ word: 'rain', emoji: 'üåßÔ∏è', hint: 'Water falling from clouds', sentence: 'The ___ made puddles everywhere.' },{ word: 'moon', emoji: 'üåô', hint: 'It shines at night in the sky', sentence: 'The ___ was bright last night.' },{ word: 'star', emoji: '‚≠ê', hint: 'Tiny lights that twinkle at night', sentence: 'I wished upon a ___.' },{ word: 'tree', emoji: 'üå≥', hint: 'A tall plant with branches and leaves', sentence: 'The ___ has green leaves.' },{ word: 'lake', emoji: 'üèûÔ∏è', hint: 'A body of water surrounded by land', sentence: 'We went fishing at the ___.' },{ word: 'snow', emoji: '‚ùÑÔ∏è', hint: 'White frozen flakes that fall in winter', sentence: 'The ___ covered the ground.' },{ word: 'wind', emoji: 'üí®', hint: 'Moving air you can feel but not see', sentence: 'The ___ blew my hat away.' },{ word: 'leaf', emoji: 'üçÉ', hint: 'The green flat part of a plant', sentence: 'A ___ fell from the tree.' },{ word: 'hill', emoji: '‚õ∞Ô∏è', hint: 'A raised area of land, smaller than a mountain', sentence: 'Jack and Jill went up the ___.' },{ word: 'seed', emoji: 'üå±', hint: 'Plant this and a flower will grow', sentence: 'I planted a ___ in the pot.' },{ word: 'pond', emoji: 'üíß', hint: 'A small body of still water', sentence: 'The ducks swam in the ___.' },{ word: 'cave', emoji: 'üï≥Ô∏è', hint: 'A large hole in a rock or mountain', sentence: 'The bear slept in the ___.' },],hard: [{ word: 'river', emoji: 'üèûÔ∏è', hint: 'Water that flows to the sea', sentence: 'The ___ flowed through the valley.' },{ word: 'ocean', emoji: 'üåä', hint: 'The biggest body of water on earth', sentence: 'Whales live in the ___.' },{ word: 'cloud', emoji: '‚òÅÔ∏è', hint: 'White fluffy things in the sky', sentence: 'The ___ looks like a bunny.' },{ word: 'storm', emoji: '‚õàÔ∏è', hint: 'Bad weather with thunder and lightning', sentence: 'The ___ was very loud.' },{ word: 'beach', emoji: 'üèñÔ∏è', hint: 'Sandy place next to the sea', sentence: 'We built sandcastles at the ___.' },{ word: 'flower', emoji: 'üå∏', hint: 'A colourful part of a plant that smells nice', sentence: 'The ___ smelled beautiful.' },{ word: 'forest', emoji: 'üå≤', hint: 'A large area full of trees', sentence: 'We walked through the ___.' },{ word: 'garden', emoji: 'üåª', hint: 'A place where you grow flowers and plants', sentence: 'We planted roses in the ___.' },{ word: 'island', emoji: 'üèùÔ∏è', hint: 'Land surrounded by water on all sides', sentence: 'The pirate found a treasure ___.' },{ word: 'desert', emoji: 'üèúÔ∏è', hint: 'A hot dry sandy place', sentence: 'The camel walked through the ___.' },{ word: 'rainbow', emoji: 'üåà', hint: 'Colourful arc in the sky after rain', sentence: 'We saw a ___ after the rain.' },{ word: 'volcano', emoji: 'üåã', hint: 'A mountain that can explode with lava', sentence: 'The ___ erupted with hot lava.' },]},
 things: {emoji: 'üéí',label: 'Things',easy: [{ word: 'hat', emoji: 'üé©', hint: 'You wear this on your head', sentence: 'I wore a ___ in the sun.' },{ word: 'cup', emoji: 'ü•§', hint: 'You drink from this', sentence: 'I drank water from a ___.' },{ word: 'bag', emoji: 'üéí', hint: 'You carry your things in this', sentence: 'I put my books in my ___.' },{ word: 'bed', emoji: 'üõèÔ∏è', hint: 'You sleep on this', sentence: 'I jump on my ___.' },{ word: 'box', emoji: 'üì¶', hint: 'You can put things inside this', sentence: 'The toy was in a ___.' },{ word: 'pen', emoji: 'üñäÔ∏è', hint: 'You write with this', sentence: 'I wrote my name with a ___.' },{ word: 'bus', emoji: 'üöå', hint: 'A big vehicle that carries many people', sentence: 'I take the ___ to school.' },{ word: 'car', emoji: 'üöó', hint: 'A vehicle with four wheels', sentence: 'Dad drove the ___ to the shop.' },{ word: 'map', emoji: 'üó∫Ô∏è', hint: 'Shows you where places are', sentence: 'We used a ___ to find the way.' },{ word: 'key', emoji: 'üîë', hint: 'You use this to open a lock', sentence: 'I used the ___ to open the door.' },],medium: [{ word: 'ball', emoji: '‚öΩ', hint: 'You kick or throw this round toy', sentence: 'I kicked the ___ into the goal.' },{ word: 'book', emoji: 'üìñ', hint: 'You read stories in this', sentence: 'I love reading a good ___.' },{ word: 'bell', emoji: 'üîî', hint: 'It makes a ringing sound', sentence: 'The school ___ rang loudly.' },{ word: 'ship', emoji: 'üö¢', hint: 'A big boat that sails on the sea', sentence: 'The ___ sailed across the ocean.' },{ word: 'drum', emoji: 'ü•Å', hint: 'A musical instrument you hit', sentence: 'I played the ___ in the band.' },{ word: 'flag', emoji: 'üö©', hint: 'A piece of cloth on a pole with a design', sentence: 'The ___ waved in the wind.' },{ word: 'lamp', emoji: 'üí°', hint: 'It gives you light', sentence: 'I turned on the ___ to read.' },{ word: 'kite', emoji: 'ü™Å', hint: 'You fly this in the wind with a string', sentence: 'My ___ flew high in the sky.' },{ word: 'ring', emoji: 'üíç', hint: 'Jewellery you wear on your finger', sentence: 'She wore a shiny ___.' },{ word: 'shoe', emoji: 'üëü', hint: 'You wear these on your feet', sentence: 'I tied my ___ laces.' },{ word: 'door', emoji: 'üö™', hint: 'You open this to go into a room', sentence: 'Please close the ___.' },{ word: 'gift', emoji: 'üéÅ', hint: 'A present you give someone', sentence: 'I got a ___ for my birthday.' },],hard: [{ word: 'clock', emoji: 'üïê', hint: 'It tells you the time', sentence: 'The ___ says it is noon.' },{ word: 'chair', emoji: 'ü™ë', hint: 'You sit on this', sentence: 'I sat down on the ___.' },{ word: 'piano', emoji: 'üéπ', hint: 'A musical instrument with black and white keys', sentence: 'She played a song on the ___.' },{ word: 'train', emoji: 'üöÇ', hint: 'It runs on tracks and says choo choo', sentence: 'The ___ arrived at the station.' },{ word: 'brush', emoji: 'üñåÔ∏è', hint: 'You use this to paint or fix your hair', sentence: 'I used a ___ to paint.' },{ word: 'phone', emoji: 'üì±', hint: 'You use this to call people', sentence: 'Mum talked on the ___.' },{ word: 'table', emoji: 'ü™ë', hint: 'You put food on this to eat', sentence: 'We ate dinner at the ___.' },{ word: 'crown', emoji: 'üëë', hint: 'A king or queen wears this on their head', sentence: 'The queen wore a golden ___.' },{ word: 'candle', emoji: 'üïØÔ∏è', hint: 'It gives light when you light it with fire', sentence: 'We lit a ___ on the cake.' },{ word: 'castle', emoji: 'üè∞', hint: 'Kings and queens live in this big building', sentence: 'The princess lived in a ___.' },{ word: 'rocket', emoji: 'üöÄ', hint: 'It flies into space', sentence: 'The ___ launched into space.' },{ word: 'camera', emoji: 'üì∑', hint: 'You take photos with this', sentence: 'I took a picture with my ___.' },]},
 people: {emoji: 'üë®‚Äçüë©‚Äçüëß',label: 'People',easy: [{ word: 'mum', emoji: 'üë©', hint: 'Your mother', sentence: 'My ___ reads me a story.' },{ word: 'dad', emoji: 'üë®', hint: 'Your father', sentence: 'My ___ plays with me.' },{ word: 'boy', emoji: 'üë¶', hint: 'A young male child', sentence: 'The ___ kicked the ball.' },{ word: 'man', emoji: 'üë®', hint: 'A grown-up male', sentence: 'The ___ walked his dog.' },{ word: 'pal', emoji: 'ü§ù', hint: 'Another word for friend', sentence: 'She is my best ___.' },],medium: [{ word: 'girl', emoji: 'üëß', hint: 'A young female child', sentence: 'The ___ sang a song.' },{ word: 'baby', emoji: 'üë∂', hint: 'A very young child', sentence: 'The ___ started to cry.' },{ word: 'king', emoji: 'üëë', hint: 'A male ruler of a country', sentence: 'The ___ wore a golden crown.' },{ word: 'hero', emoji: 'ü¶∏', hint: 'Someone who is brave and saves people', sentence: 'The ___ saved the day!' },{ word: 'chef', emoji: 'üë®‚Äçüç≥', hint: 'A person who cooks food', sentence: 'The ___ made a delicious meal.' },{ word: 'lady', emoji: 'üë©', hint: 'A polite word for a woman', sentence: 'The kind ___ helped me.' },],hard: [{ word: 'queen', emoji: 'üë∏', hint: 'A female ruler of a country', sentence: 'The ___ lived in a palace.' },{ word: 'nurse', emoji: 'üë©‚Äç‚öïÔ∏è', hint: 'A person who helps sick people in hospital', sentence: 'The ___ gave me a bandage.' },{ word: 'fairy', emoji: 'üßö', hint: 'A magical tiny person with wings', sentence: 'The ___ waved her magic wand.' },{ word: 'giant', emoji: 'üëπ', hint: 'A very very tall person in stories', sentence: 'The ___ stomped through the town.' },{ word: 'pirate', emoji: 'üè¥‚Äç‚ò†Ô∏è', hint: 'They sail the seas and look for treasure', sentence: 'The ___ found a treasure map.' },{ word: 'knight', emoji: '‚öîÔ∏è', hint: 'A soldier in armour who rides a horse', sentence: 'The brave ___ fought the dragon.' },{ word: 'doctor', emoji: 'üë®‚Äç‚öïÔ∏è', hint: 'A person who helps you when you are sick', sentence: 'The ___ checked my temperature.' },{ word: 'friend', emoji: 'üòä', hint: 'Someone you like and play with', sentence: 'She is my best ___.' },{ word: 'wizard', emoji: 'üßô‚Äç‚ôÇÔ∏è', hint: 'A magical man who casts spells', sentence: 'The ___ cast a powerful spell.' },{ word: 'prince', emoji: 'ü§¥', hint: 'The son of a king and queen', sentence: 'The ___ rode a white horse.' },{ word: 'teacher', emoji: 'üë©‚Äçüè´', hint: 'A person who teaches you at school', sentence: 'My ___ is very kind.' },{ word: 'princess', emoji: 'üë∏', hint: 'The daughter of a king and queen', sentence: 'The ___ wore a beautiful dress.' },]},
 colours: {emoji: 'üé®',label: 'Colours',easy: [{ word: 'red', emoji: 'üî¥', hint: 'The colour of a fire engine', sentence: 'The apple is ___.' },{ word: 'blue', emoji: 'üîµ', hint: 'The colour of the sky', sentence: 'The sky is ___.' },{ word: 'pink', emoji: 'üíó', hint: 'A light shade of red', sentence: 'Her dress is ___.' },{ word: 'gold', emoji: '‚≠ê', hint: 'The colour of treasure', sentence: 'The star is ___.' },],medium: [{ word: 'green', emoji: 'üíö', hint: 'The colour of grass and leaves', sentence: 'The grass is ___.' },{ word: 'black', emoji: '‚ö´', hint: 'The colour of night', sentence: 'The cat is ___.' },{ word: 'white', emoji: '‚ö™', hint: 'The colour of snow', sentence: 'The snow is ___.' },{ word: 'brown', emoji: 'üü§', hint: 'The colour of chocolate', sentence: 'The bear is ___.' },{ word: 'grey', emoji: 'ü©∂', hint: 'A colour between black and white', sentence: 'The elephant is ___.' },],hard: [{ word: 'orange', emoji: 'üü†', hint: 'The colour of a carrot', sentence: 'The sunset was ___.' },{ word: 'yellow', emoji: 'üü°', hint: 'The colour of the sun', sentence: 'The sunflower is ___.' },{ word: 'purple', emoji: 'üü£', hint: 'The colour of grapes', sentence: 'The butterfly is ___.' },{ word: 'silver', emoji: 'ü™ô', hint: 'A shiny grey colour like a coin', sentence: 'The moon looked ___.' },{ word: 'violet', emoji: 'üíú', hint: 'A purple-blue flower colour', sentence: 'The ___ flowers bloomed in spring.' }]},
 sports: {emoji: '‚öΩ',label: 'Sports',easy: [{ word: 'run', emoji: 'üèÉ', hint: 'Move faster than walking', sentence: 'I like to ___ in the park.' },{ word: 'win', emoji: 'üèÜ', hint: 'To be first in a game', sentence: 'I want to ___ the race.' },{ word: 'bat', emoji: 'üèè', hint: 'Used to hit a ball', sentence: 'Swing the ___!' },{ word: 'net', emoji: 'ü•Ö', hint: 'A mesh used in games like tennis', sentence: 'Kick the ball into the ___.' }],medium: [{ word: 'swim', emoji: 'üèä', hint: 'Move through water', sentence: 'Can you ___ in the deep end?' },{ word: 'jump', emoji: 'ü§∏', hint: 'Push off the ground', sentence: 'How high can you ___?' },{ word: 'goal', emoji: 'ü•Ö', hint: 'Where you score points', sentence: 'She scored a ___!' },{ word: 'team', emoji: 'üë•', hint: 'A group playing together', sentence: 'My ___ won the game.' },{ word: 'kick', emoji: 'ü¶∂', hint: 'Hit with your foot', sentence: '___ the ball hard!' }],hard: [{ word: 'soccer', emoji: '‚öΩ', hint: 'Game where you kick a ball', sentence: 'We play ___ on Saturdays.' },{ word: 'tennis', emoji: 'üéæ', hint: 'Game with rackets and a net', sentence: 'I need a ball for ___.' },{ word: 'karate', emoji: 'ü•ã', hint: 'A fighting sport from Japan', sentence: 'He practices ___ moves.' },{ word: 'hockey', emoji: 'üèí', hint: 'Played on ice with sticks', sentence: 'The ___ puck slid fast.' },{ word: 'trophy', emoji: 'üèÜ', hint: 'A prize for winning', sentence: 'The winner gets a gold ___.' },{ word: 'helmet', emoji: '‚õëÔ∏è', hint: 'Hard hat for safety', sentence: 'Wear your ___ when biking.' }]},
 clothes: {emoji: 'üëï',label: 'Clothes',easy: [{ word: 'hat', emoji: 'üß¢', hint: 'Worn on your head', sentence: 'Put on your sun ___.' },{ word: 'tie', emoji: 'üëî', hint: 'Worn around the neck', sentence: 'Dad wore a blue ___.' },{ word: 'sock', emoji: 'üß¶', hint: 'Worn inside a shoe', sentence: 'I lost one ___.' },{ word: 'cap', emoji: 'üß¢', hint: 'A type of hat', sentence: 'He wore a baseball ___.' }],medium: [{ word: 'shirt', emoji: 'üëï', hint: 'Upper body clothing', sentence: 'My ___ is red.' },{ word: 'boot', emoji: 'üë¢', hint: 'Strong shoe for walking', sentence: 'Put on your rain ___.' },{ word: 'dress', emoji: 'üëó', hint: 'One-piece clothing', sentence: 'She wore a pretty ___.' },{ word: 'coat', emoji: 'üß•', hint: 'Outer wear for cold', sentence: 'Button up your ___.' },{ word: 'scarf', emoji: 'üß£', hint: 'Warm cloth for your neck', sentence: 'Wrap the ___ tightly.' }],hard: [{ word: 'jacket', emoji: 'üß•', hint: 'A short coat', sentence: 'Zip up your ___.' },{ word: 'gloves', emoji: 'üß§', hint: 'Cover for hands', sentence: 'My hands are cold, I need ___.' },{ word: 'shorts', emoji: 'ü©≥', hint: 'Short trousers', sentence: 'Wear ___ in summer.' },{ word: 'sweater', emoji: 'üß∂', hint: 'Knitted warm top', sentence: 'Grandma knit a green ___.' },{ word: 'pajama', emoji: 'üõå', hint: 'Clothes for sleeping', sentence: 'Put on your ___ for bed.' }]},
 body: {emoji: 'ü¶µ',label: 'Body',easy: [{ word: 'eye', emoji: 'üëÅÔ∏è', hint: 'You see with this', sentence: 'Close your left ___.' },{ word: 'ear', emoji: 'üëÇ', hint: 'You hear with this', sentence: 'Whisper in my ___.' },{ word: 'arm', emoji: 'üí™', hint: 'Limb attached to shoulder', sentence: 'Raise your right ___.' },{ word: 'leg', emoji: 'ü¶µ', hint: 'Limb used for walking', sentence: 'Hop on one ___.' },{ word: 'toe', emoji: 'üë£', hint: 'End of your foot', sentence: 'Wiggle your big ___.' }],medium: [{ word: 'hand', emoji: '‚úã', hint: 'At the end of your arm', sentence: 'Wave your ___.' },{ word: 'foot', emoji: 'ü¶∂', hint: 'You stand on this', sentence: 'Stomp your ___.' },{ word: 'nose', emoji: 'üëÉ', hint: 'You smell with this', sentence: 'Touch your ___.' },{ word: 'face', emoji: 'üòä', hint: 'Front part of your head', sentence: 'Wash your ___.' },{ word: 'hair', emoji: 'üíá', hint: 'Grows on your head', sentence: 'Brush your ___.' }],hard: [{ word: 'heart', emoji: '‚ù§Ô∏è', hint: 'Beats inside your chest', sentence: 'My ___ beats fast.' },{ word: 'mouth', emoji: 'üëÑ', hint: 'You eat and speak with this', sentence: 'Open your ___ wide.' },{ word: 'brain', emoji: 'üß†', hint: 'Inside head, used to think', sentence: 'Use your ___ to solve it.' },{ word: 'tooth', emoji: 'ü¶∑', hint: 'White part in mouth for biting', sentence: 'I lost a baby ___.' },{ word: 'finger', emoji: '‚òùÔ∏è', hint: 'Part of your hand', sentence: 'Point with your ___.' },{ word: 'tongue', emoji: 'üëÖ', hint: 'Inside mouth, tastes food', sentence: 'Stick out your ___.' }]},
 space: {emoji: 'ü™ê',label: 'Space',easy: [{ word: 'sun', emoji: '‚òÄÔ∏è', hint: 'Big star that warms us', sentence: 'The ___ is hot.' },{ word: 'sky', emoji: 'üåå', hint: 'Space above the earth', sentence: 'Look up at the ___.' }],medium: [{ word: 'moon', emoji: 'üåô', hint: 'Orbits the earth', sentence: 'The ___ comes out at night.' },{ word: 'star', emoji: '‚≠ê', hint: 'Twinkling light in space', sentence: 'Make a wish on a ___.' },{ word: 'mars', emoji: 'üî¥', hint: 'The Red Planet', sentence: '___ is next to Earth.' }],hard: [{ word: 'earth', emoji: 'üåç', hint: 'The planet we live on', sentence: 'We must protect the ___.' },{ word: 'alien', emoji: 'üëΩ', hint: 'Life from another planet', sentence: 'An ___ landed its ship.' },{ word: 'comet', emoji: '‚òÑÔ∏è', hint: 'Ball of ice and dust in space', sentence: 'A ___ has a tail.' },{ word: 'planet', emoji: 'ü™ê', hint: 'Large body orbiting a sun', sentence: 'Jupiter is a big ___.' },{ word: 'rocket', emoji: 'üöÄ', hint: 'Vehicle for space travel', sentence: 'The ___ blasted off.' },{ word: 'orbit', emoji: 'üîÑ', hint: 'Path around a planet', sentence: 'The satellite is in ___.' }]},
 jobs: {emoji: 'üë∑',label: 'Jobs',easy: [{ word: 'vet', emoji: 'üê∂', hint: 'Animal doctor', sentence: 'The ___ helped my dog.' },{ word: 'cop', emoji: 'üëÆ', hint: 'Police officer', sentence: 'The ___ stopped traffic.' }],medium: [{ word: 'cook', emoji: 'üë®‚Äçüç≥', hint: 'Makes food', sentence: 'The ___ made soup.' },{ word: 'boss', emoji: 'üëî', hint: 'Person in charge', sentence: 'Ask your ___ first.' },{ word: 'maid', emoji: 'üßπ', hint: 'Cleans houses', sentence: 'The ___ cleaned the room.' }],hard: [{ word: 'doctor', emoji: 'ü©∫', hint: 'Treats sick people', sentence: 'The ___ gave medicine.' },{ word: 'farmer', emoji: 'üöú', hint: 'Grows food', sentence: 'The ___ drove a tractor.' },{ word: 'artist', emoji: 'üé®', hint: 'Makes art', sentence: 'The ___ painted a picture.' },{ word: 'pilot', emoji: '‚úàÔ∏è', hint: 'Flies a plane', sentence: 'The ___ landed safely.' },{ word: 'nurse', emoji: 'üíâ', hint: 'Helps the doctor', sentence: 'The ___ took my pulse.' },{ word: 'baker', emoji: 'ü•ê', hint: 'Bakes bread', sentence: 'The ___ made fresh rolls.' }]},
 vehicles: {emoji: 'üöõ',label: 'Vehicles',easy: [{ word: 'bus', emoji: 'üöå', hint: 'Big car for many people', sentence: 'Ride the ___ to school.' },{ word: 'van', emoji: 'üöê', hint: 'Boxy vehicle', sentence: 'We loaded the ___.' },{ word: 'jet', emoji: '‚úàÔ∏è', hint: 'Fast plane', sentence: 'The ___ flew high.' }],medium: [{ word: 'boat', emoji: '‚õµ', hint: 'Travels on water', sentence: 'Row the ___.' },{ word: 'ship', emoji: 'üö¢', hint: 'Large boat', sentence: 'The cargo ___ is huge.' },{ word: 'taxi', emoji: 'üöï', hint: 'Car you pay to ride', sentence: 'Hail a yellow ___.' },{ word: 'bike', emoji: 'üö≤', hint: 'Two-wheeled vehicle', sentence: 'Ride your ___.' }],hard: [{ word: 'truck', emoji: 'üöö', hint: 'Carries heavy loads', sentence: 'The dump ___ is full.' },{ word: 'train', emoji: 'üöÜ', hint: 'Runs on rails', sentence: 'The ___ whistled.' },{ word: 'plane', emoji: 'üõ´', hint: 'Files in the air', sentence: 'Board the ___ now.' },{ word: 'motor', emoji: '‚öôÔ∏è', hint: 'Engine', sentence: 'The ___ is loud.' },{ word: 'wagon', emoji: 'üöú', hint: 'Cart pulled by horse or handle', sentence: 'Pull the red ___.' }]}
};

let gameState={
 selectedCategories:[],
 difficulty:'easy',
 words:[],
 currentIndex:0,
 correctCount:0,
 wrongCount:0,
 streak:0,
 maxStreak:0,
 attempts:0,
 maxAttempts:3,
 hintsUsed:0,
 maxHints:3,
 results:[],
 totalWords:10,
 currentHintLevel:0
};
function spellShowScreen(id){
 document.querySelectorAll('.spell-screen').forEach(s=>s.classList.remove('active'));
 $(id).classList.add('active');
}
function initSpelling(){
 renderCategories();
 $('spellInput').addEventListener('keypress',e=>{if(e.key==='Enter')checkAnswer()});
 $('spellInput').addEventListener('input',e=>{updateLetterBoxes(e.target.value)});
}
function renderCategories(){
 const grid=$('categoryGrid');grid.innerHTML='';
 for(const [key,cat] of Object.entries(wordDatabase)){
  const btn=document.createElement('button');
  btn.className='category-btn';btn.setAttribute('data-category',key);
  btn.innerHTML=`<span class="cat-emoji">${cat.emoji}</span>${cat.label}`;
  btn.onclick=()=>toggleCategory(key,btn);
  grid.appendChild(btn);
 }
}
function toggleCategory(cat,btn){
 const idx=gameState.selectedCategories.indexOf(cat);
 if(idx>-1){gameState.selectedCategories.splice(idx,1);btn.classList.remove('selected')}
 else{gameState.selectedCategories.push(cat);btn.classList.add('selected')}
 $('startBtn').disabled=gameState.selectedCategories.length===0;
}
function setDifficulty(diff){
 gameState.difficulty=diff;
 document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('selected'));
 $('diff'+diff.charAt(0).toUpperCase()+diff.slice(1)).classList.add('selected');
}
function startGame(){
 if(gameState.selectedCategories.length===0)return;
 let allWords=[];
 gameState.selectedCategories.forEach(cat=>{
  const catData=wordDatabase[cat];
  if(catData[gameState.difficulty])allWords=allWords.concat(catData[gameState.difficulty]);
  if(gameState.difficulty==='hard'&&catData['medium'])allWords=allWords.concat(catData['medium']);
  if(gameState.difficulty==='medium'&&catData['easy'])allWords=allWords.concat(catData['easy']);
 });
 const seen=new Set();allWords=allWords.filter(w=>{if(seen.has(w.word))return false;seen.add(w.word);return true});
 allWords=shuffleArray(allWords);gameState.words=allWords.slice(0,gameState.totalWords);
 if(gameState.words.length===0){alert('No words found! Please select at least one category.');return}
 gameState.currentIndex=0;gameState.correctCount=0;gameState.wrongCount=0;gameState.streak=0;gameState.maxStreak=0;gameState.results=[];
 spellShowScreen('gameScreen');loadWord();
}
function loadWord(){
 const word=gameState.words[gameState.currentIndex];
 gameState.attempts=0;gameState.currentHintLevel=0;
 const progress=((gameState.currentIndex)/gameState.words.length)*100;
 $('progressBar').style.width=progress+'%';
 $('progressText').textContent=`${gameState.currentIndex+1} / ${gameState.words.length}`;
 $('correctCount').textContent=gameState.correctCount;
 $('wrongCount').textContent=gameState.wrongCount;
 if(gameState.streak>=2){
  $('streakContainer').style.display='inline-block';
  $('streakCount').textContent=gameState.streak;
  $('streakContainer').className=gameState.streak>=5?'streak-badge hot':'streak-badge';
 }else $('streakContainer').style.display='none';
 $('wordEmoji').textContent=word.emoji;
 updateAttemptsDisplay();
 createLetterBoxes(word.word.length);
 const input=$('spellInput');
 input.value='';input.className='spell-input';input.disabled=false;
 input.maxLength=word.word.length;
 input.placeholder=`Type the word (${word.word.length} letters)...`;
 input.focus();
 $('feedback').className='feedback';$('feedback').textContent='';
 $('wordInfo').classList.remove('visible');
 $('actionButtons').style.display='flex';
 $('nextBtnContainer').style.display='none';
 $('hintBtn').disabled=false;
}
function createLetterBoxes(length){
 const container=$('letterBoxes');container.innerHTML='';
 for(let i=0;i<length;i++){const box=document.createElement('div');box.className='letter-box';box.id='box-'+i;box.textContent='';container.appendChild(box)}
}
function updateLetterBoxes(value){
 const word=gameState.words[gameState.currentIndex];
 for(let i=0;i<word.word.length;i++){
  const box=$('box-'+i);if(!box)continue;
  if(box.classList.contains('hint'))continue;
  if(i<value.length){
   box.textContent=value[i].toUpperCase();box.classList.add('filled');
  }else{box.textContent='';box.classList.remove('filled')}
 }
}
function updateAttemptsDisplay(){
 let hearts='';for(let i=0;i<gameState.maxAttempts;i++){
  if(i<gameState.maxAttempts-gameState.attempts)hearts+='<span class="heart">‚ù§Ô∏è</span> ';
  else hearts+='<span class="heart lost">‚ù§Ô∏è</span> ';
 }
 $('attemptsDisplay').innerHTML=hearts;
}
// Check answer
function checkAnswer(){
 const input=$('spellInput');const userAnswer=input.value.trim().toLowerCase();
 const word=gameState.words[gameState.currentIndex];const correctWord=word.word.toLowerCase();
 if(userAnswer===''){showFeedback('Please type your answer!','error');input.focus();return}
 if(userAnswer===correctWord)handleCorrectAnswer(word);
 else{gameState.attempts++;updateAttemptsDisplay();if(gameState.attempts>=gameState.maxAttempts)handleOutOfAttempts(word,correctWord);else handleIncorrectAnswer(userAnswer,correctWord,word)}
}
function handleCorrectAnswer(word){
 gameState.correctCount++;gameState.streak++;if(gameState.streak>gameState.maxStreak)gameState.maxStreak=gameState.streak;
 gameState.results.push({word:word.word,emoji:word.emoji,correct:true});
 const input=$('spellInput');input.className='spell-input correct-input';input.disabled=true;
 for(let i=0;i<word.word.length;i++){const box=$('box-'+i);box.textContent=word.word[i].toUpperCase();box.className='letter-box correct'}
 let message='';if(gameState.streak>=5)message='AMAZING! You\'re on fire!';else if(gameState.streak>=3)message='Fantastic streak! Keep going!';else if(gameState.attempts===0)message=getRandomPraise();else message='Well done! You got it!';
 showFeedback(message,'success');showWordInfo(word);createMiniConfetti();speakWord();
 $('actionButtons').style.display='none';$('nextBtnContainer').style.display='flex';
}
function handleIncorrectAnswer(userAnswer,correctWord,word){
 const input=$('spellInput');input.className='spell-input incorrect-input';
 for(let i=0;i<correctWord.length;i++){
  const box=$('box-'+i);if(box.classList.contains('hint'))continue;
  if(i<userAnswer.length){
   if(userAnswer[i]===correctWord[i]){box.className='letter-box correct';box.textContent=correctWord[i].toUpperCase();}
   else box.className='letter-box incorrect';
  }
 }
 const remaining=gameState.maxAttempts-gameState.attempts;
 let hintMessage=`Not quite! You have ${remaining} ${remaining===1?'try':'tries'} left.\n`;
 if(userAnswer.length!==correctWord.length)hintMessage+=`The word has ${correctWord.length} letters, but you typed ${userAnswer.length}.`;
 else{
  let wrongPositions=[];for(let i=0;i<correctWord.length;i++){if(userAnswer[i]!==correctWord[i])wrongPositions.push(i+1)}
  if(wrongPositions.length===1)hintMessage+=`Almost! Letter number ${wrongPositions[0]} is wrong. Try again!`;
  else hintMessage+=`${wrongPositions.length} letters are wrong. Check positions: ${wrongPositions.join(', ')}`;
 }
 showFeedback(hintMessage,'error');
 if(gameState.attempts===2)setTimeout(()=>giveHint(),500);
 setTimeout(()=>{
  input.className='spell-input';input.value='';input.focus();
  for(let i=0;i<correctWord.length;i++){
   const box=$('box-'+i);
   if(!box.classList.contains('hint')&&!box.classList.contains('correct')){box.className='letter-box';box.textContent='';}
  }
 },1500);
}
function handleOutOfAttempts(word,correctWord){
 gameState.wrongCount++;gameState.streak=0;
 gameState.results.push({word:word.word,emoji:word.emoji,correct:false});
 const input=$('spellInput');input.className='spell-input incorrect-input';input.disabled=true;input.value=correctWord;
 for(let i=0;i<correctWord.length;i++){const box=$('box-'+i);box.textContent=correctWord[i].toUpperCase();box.className='letter-box incorrect'}
 showFeedback(`The correct spelling is: "${correctWord.toUpperCase()}"\nDon't worry, you'll get it next time!`,'hint-msg');
 showWordInfo(word);speakWord();
 $('actionButtons').style.display='none';$('nextBtnContainer').style.display='flex';
}
// Hints
function giveHint(){
 const word=gameState.words[gameState.currentIndex];const correctWord=word.word.toLowerCase();
 gameState.currentHintLevel++;let hintMessage='';
 switch(gameState.currentHintLevel){
  case 1:hintMessage=`Hint: ${word.hint}`;break;
  case 2:const firstBox=$('box-0');firstBox.textContent=correctWord[0].toUpperCase();firstBox.className='letter-box hint';hintMessage=`Hint: The word starts with "${correctWord[0].toUpperCase()}"`;if(word.sentence)hintMessage+=`\n${word.sentence}`;break;
  case 3:const lastBox=$('box-'+(correctWord.length-1));lastBox.textContent=correctWord[correctWord.length-1].toUpperCase();lastBox.className='letter-box hint';hintMessage=`Hint: The word ends with "${correctWord[correctWord.length-1].toUpperCase()}"`;break;
  default:
   let hiddenBoxes=[];for(let i=0;i<correctWord.length;i++){const box=$('box-'+i);if(!box.classList.contains('hint')&&!box.classList.contains('correct'))hiddenBoxes.push(i)}
   if(hiddenBoxes.length>0){const revealIdx=hiddenBoxes[Math.floor(Math.random()*hiddenBoxes.length)];const box=$('box-'+revealIdx);box.textContent=correctWord[revealIdx].toUpperCase();box.className='letter-box hint';hintMessage=`Hint: Letter ${revealIdx+1} is "${correctWord[revealIdx].toUpperCase()}"`;}
   else hintMessage='All letters are revealed!';
   break;
 }
 showFeedback(hintMessage,'hint-msg');
 if(gameState.currentHintLevel>=correctWord.length)$('hintBtn').disabled=true;
 if(gameState.currentHintLevel===1)speakWord();
 $('spellInput').focus();
}
function skipWord(){
 const word=gameState.words[gameState.currentIndex];
 gameState.wrongCount++;gameState.streak=0;
 gameState.results.push({word:word.word,emoji:word.emoji,correct:false});
 const input=$('spellInput');input.value=word.word;input.disabled=true;input.className='spell-input incorrect-input';
 for(let i=0;i<word.word.length;i++){const box=$('box-'+i);box.textContent=word.word[i].toUpperCase();box.className='letter-box hint'}
 showFeedback(`The word was: "${word.word.toUpperCase()}" ‚Äî You'll learn it next time!`,'hint-msg');
 showWordInfo(word);speakWord();
 $('actionButtons').style.display='none';$('nextBtnContainer').style.display='flex';
}
function nextWord(){
 gameState.currentIndex++;
 if(gameState.currentIndex>=gameState.words.length)showResults();
 else loadWord();
}
function showResults(){
 spellShowScreen('resultsScreen');
 const total=gameState.words.length;const correct=gameState.correctCount;
 const percentage=Math.round((correct/total)*100);
 $('finalScore').textContent=`${correct} / ${total}`;
 let stars='';if(percentage>=90)stars='‚≠ê‚≠ê‚≠ê';else if(percentage>=70)stars='‚≠ê‚≠ê';else if(percentage>=50)stars='‚≠ê';else stars='‚ú®';
 $('starsDisplay').textContent=stars;
 let trophy='üèÖ';if(percentage>=90)trophy='üèÜ';else if(percentage>=70)trophy='ü•á';else if(percentage>=50)trophy='ü•à';else trophy='üéñÔ∏è';
 $('trophyIcon').textContent=trophy;
 let title='Great Job!';let message='';
 if(percentage===100){title='PERFECT SCORE!';message='You are a spelling champion! Every single word was correct!';createConfetti();}
 else if(percentage>=90){title='Amazing!';message='You are almost perfect! Just a tiny bit more practice!';createConfetti();}
 else if(percentage>=70){title='Well Done!';message='Great effort! Keep practising and you\'ll be even better!';}
 else if(percentage>=50){title='Good Try!';message='You\'re learning! Try the words you missed again!';}
 else{title='Keep Going!';message='Practice makes perfect! Try again and you\'ll improve!';}
 if(gameState.maxStreak>=3)message+=` Best streak: ${gameState.maxStreak} in a row!`;
 $('resultsTitle').textContent=title;$('resultsMessage').textContent=message;
 const grid=$('resultsGrid');grid.innerHTML='';
 gameState.results.forEach(r=>{
  const item=document.createElement('div');item.className='result-item '+(r.correct?'got-right':'got-wrong');
  item.innerHTML=`<div class="result-emoji">${r.emoji}</div><div>${r.word}</div><div>${r.correct?'‚úÖ':'‚ùå'}</div>`;grid.appendChild(item);
 });
}
function showScreenSpellingWrapper(id){spellShowScreen(id);}
function goToStart(){
 gameState.selectedCategories=[];document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('selected'));
 $('startBtn').disabled=true;spellShowScreen('startScreen');
}
function showFeedback(message,type){
 const feedback=$('feedback');feedback.textContent=message;feedback.className='feedback '+type;
 feedback.style.animation='none';feedback.offsetHeight;feedback.style.animation='';
}
function showWordInfo(word){
 const info=$('wordInfo');
 info.innerHTML=`<p><span class="word-label">Word:</span> ${word.word.toUpperCase()}</p><p><span class="word-label">Meaning:</span> ${word.hint}</p><p><span class="word-label">Sentence:</span> ${word.sentence.replace('___','<strong>'+word.word+'</strong>')}</p>`;
 info.classList.add('visible');
}
function speakWord(){
 const word=gameState.words[gameState.currentIndex];if(!word)return;
 if('speechSynthesis'in window){
  window.speechSynthesis.cancel();
  const utterance=new SpeechSynthesisUtterance(word.word);
  utterance.rate=0.8;utterance.pitch=1.1;utterance.lang='en-GB';
  window.speechSynthesis.speak(utterance);
 }
}
function getRandomPraise(){
 const praises=[
  'Perfect! You\'re a spelling star!',
  'Brilliant! First try!',
  'Wonderful! You nailed it!',
  'Superb! You\'re amazing!',
  'Excellent spelling!',
  'Great job, champion!',
  'Hooray! That\'s correct!',
  'You\'re a spelling wizard!',
  'Super speller!',
  'Spot on! Perfect spelling!'
 ];
 return praises[Math.floor(Math.random()*praises.length)];
}
function shuffleArray(array){
 const shuffled=[...array];
 for(let i=shuffled.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));[shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];
 }
 return shuffled;
}
function createConfetti(){
 const container=$('confettiContainer');
 const colors=['#ff6b6b','#feca57','#48dbfb','#ff9ff3','#54a0ff','#00b894','#fdcb6e'];
 for(let i=0;i<100;i++){
  setTimeout(()=>{
   const piece=document.createElement('div');
   piece.className='confetti-piece';
   piece.style.left=Math.random()*100+'%';
   piece.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
   piece.style.animationDuration=(Math.random()*2+2)+'s';
   piece.style.animationDelay=Math.random()*0.5+'s';
   piece.style.width=(Math.random()*8+5)+'px';
   piece.style.height=(Math.random()*15+8)+'px';
   piece.style.borderRadius=Math.random()>0.5?'50%':'0';
   container.appendChild(piece);setTimeout(()=>piece.remove(),4000);
  },i*30);
 }
}
function createMiniConfetti(){
 const container=$('confettiContainer');
 const colors=['#00b894','#00cec9','#55efc4','#ffeaa7','#fdcb6e'];
 for(let i=0;i<20;i++){
  setTimeout(()=>{
   const piece=document.createElement('div');
   piece.className='confetti-piece';
   piece.style.left=(30+Math.random()*40)+'%';
   piece.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
   piece.style.animationDuration=(Math.random()*1.5+1.5)+'s';
   piece.style.width=(Math.random()*6+4)+'px';
   piece.style.height=(Math.random()*10+6)+'px';
   piece.style.borderRadius=Math.random()>0.5?'50%':'0';
   container.appendChild(piece);setTimeout(()=>piece.remove(),3000);
  },i*50);
 }
}
function goToHubFromSpelling(){goToStart();showHub();}

// ================================================================
// GAME 4: VISUAL FRACTION TEACHER
// ================================================================
let n1,d1,n2,d2;let common,total;let step=0;
function gcd(a,b){return b===0?a:gcd(b,a%b)}
function lcm(a,b){return (a*b)/gcd(a,b)}
function generateBar(n,d,className){
 let bar="<div class='bar'>";
 for(let i=0;i<d;i++){
  if(i<n)bar+="<div class='piece "+className+"'></div>";
  else bar+="<div class='piece'></div>";
 }
 bar+="</div>";return bar;
}
function newQuestion(){
 step=0;
 const denominators=[2,3,4,5,6];
 d1=denominators[Math.floor(Math.random()*denominators.length)];
 d2=denominators[Math.floor(Math.random()*denominators.length)];
 n1=Math.floor(Math.random()*(d1-1))+1;
 n2=Math.floor(Math.random()*(d2-1))+1;
 common=lcm(d1,d2);
 total=n1*(common/d1)+n2*(common/d2);
 if(total<=common)return newQuestion();
 $('question').innerText=n1+"/"+d1+" + "+n2+"/"+d2;
 $('bars').innerHTML=generateBar(n1,d1,"filled1")+generateBar(n2,d2,"filled2");
 $('draggableArea').innerHTML="";
 $('dropzone').innerHTML="Drag pieces here to add";
 $('stepText').innerText="Step 1: Look at the fraction bars.";
}
function nextStep(){
 step++;
 if(step===1){
  $('stepText').innerText="Step 2: We need the same bottom number. The common denominator is "+common+".";
  $('bars').innerHTML=generateBar(n1*(common/d1),common,"filled1")+generateBar(n2*(common/d2),common,"filled2");
 }else if(step===2){
  $('stepText').innerText="Step 3: Drag all colored pieces into the box to add them.";
  let piecesHTML="";for(let i=0;i<total;i++){piecesHTML+="<div class='draggable' draggable='true' ondragstart='drag(event)'>1/"+common+"</div>";}
  $('draggableArea').innerHTML=piecesHTML;
 }else if(step===3){
  let whole=Math.floor(total/common);let remainder=total%common;
  if(remainder===0)$('stepText').innerText="Step 4: "+total+"/"+common+" = "+whole+". Final Answer!";
  else $('stepText').innerText="Step 4: "+total+"/"+common+" = "+whole+" remainder "+remainder+". Final Answer: "+whole+" "+remainder+"/"+common;
 }
}
function drag(ev){ev.dataTransfer.setData("text","1")}
const dropzone=document.getElementById("dropzone");
dropzone.addEventListener("dragover",function(ev){ev.preventDefault()});
dropzone.addEventListener("drop",function(ev){
 ev.preventDefault();
 let node=document.createElement("div");
 node.innerText="‚úì";
 node.style.display="inline-block";
 node.style.margin="5px";
 node.style.fontSize="20px";
 dropzone.appendChild(node);
});

// Init Spelling and Fraction question
window.addEventListener('load',()=>{
 initSpelling();
 newQuestion();
});
</script>
</body>
</html>
```
